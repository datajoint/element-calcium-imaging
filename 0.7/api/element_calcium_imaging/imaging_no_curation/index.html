
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://localhost/docs/elements/element-calcium-imaging/0.7/api/element_calcium_imaging/imaging_no_curation/">
      
      
        <link rel="prev" href="../imaging/">
      
      
        <link rel="next" href="../imaging_preprocess/">
      
      <link rel="icon" href="../../../assets/images/company-logo-blue.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>imaging_no_curation.py - DataJoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto Slab";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#element_calcium_imaging.imaging_no_curation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="DataJoint Documentation" class="md-header__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
      
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DataJoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              imaging_no_curation.py
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="datajoint" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/datajoint/element-calcium-imaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-calcium-imaging
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="" data-md-level="0">
    <label class="md-nav__title" for="__drawer">
        <a href="../../.." title="DataJoint Documentation"
            class="md-nav__button md-logo" aria-label="DataJoint Documentation" data-md-component="logo">
            
  
  <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>

        </a><a href="https://datajoint.com/docs/elements/" title="DataJoint Elements">
            ⬅ Home
        </a>
    </label>
    
    <div class="md-nav__source">
        <a href="https://github.com/datajoint/element-calcium-imaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    datajoint/element-calcium-imaging
  </div>
</a>
    </div>
    
    <ul class="md-nav__list" data-md-scrollfix>
        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Element Calcium Imaging
      </a>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../pipeline/" class="md-nav__link">
        Data Pipeline
      </a>
    </li>
  

        
        
        
        

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../tutorials/">Tutorials</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/tutorial.ipynb" class="md-nav__link">
        Tutorial Notebook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/quality_metrics.ipynb" class="md-nav__link">
        Quality Metrics Notebook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../partnerships/" class="md-nav__link">
        Key Partnerships
      </a>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../citation/" class="md-nav__link">
        Citation
      </a>
    </li>
  

        
        
        
        

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
          element_calcium_imaging
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          element_calcium_imaging
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        analysis.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../imaging/" class="md-nav__link">
        imaging.py
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          imaging_no_curation.py
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        imaging_no_curation.py
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation" class="md-nav__link">
    element_calcium_imaging.imaging_no_curation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.activate" class="md-nav__link">
    activate()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.get_imaging_root_data_dir" class="md-nav__link">
    get_imaging_root_data_dir()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingMethod" class="md-nav__link">
    ProcessingMethod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.get_processed_root_data_dir" class="md-nav__link">
    get_processed_root_data_dir()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingParamSet" class="md-nav__link">
    ProcessingParamSet
  </a>
  
    <nav class="md-nav" aria-label="ProcessingParamSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingParamSet.insert_new_params" class="md-nav__link">
    insert_new_params()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.get_image_files" class="md-nav__link">
    get_image_files()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.CellCompartment" class="md-nav__link">
    CellCompartment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MaskType" class="md-nav__link">
    MaskType
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask" class="md-nav__link">
    ProcessingTask
  </a>
  
    <nav class="md-nav" aria-label="ProcessingTask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask.infer_output_dir" class="md-nav__link">
    infer_output_dir()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask.generate" class="md-nav__link">
    generate()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Processing" class="md-nav__link">
    Processing
  </a>
  
    <nav class="md-nav" aria-label="Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Processing.key_source" class="md-nav__link">
    key_source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Processing.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection" class="md-nav__link">
    MotionCorrection
  </a>
  
    <nav class="md-nav" aria-label="MotionCorrection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.RigidMotionCorrection" class="md-nav__link">
    RigidMotionCorrection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.NonRigidMotionCorrection" class="md-nav__link">
    NonRigidMotionCorrection
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.Block" class="md-nav__link">
    Block
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.Summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Segmentation" class="md-nav__link">
    Segmentation
  </a>
  
    <nav class="md-nav" aria-label="Segmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Segmentation.Mask" class="md-nav__link">
    Mask
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Segmentation.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MaskClassificationMethod" class="md-nav__link">
    MaskClassificationMethod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MaskClassification" class="md-nav__link">
    MaskClassification
  </a>
  
    <nav class="md-nav" aria-label="MaskClassification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.MaskClassification.MaskType" class="md-nav__link">
    MaskType
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Fluorescence" class="md-nav__link">
    Fluorescence
  </a>
  
    <nav class="md-nav" aria-label="Fluorescence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Fluorescence.Trace" class="md-nav__link">
    Trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Fluorescence.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ActivityExtractionMethod" class="md-nav__link">
    ActivityExtractionMethod
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Activity" class="md-nav__link">
    Activity
  </a>
  
    <nav class="md-nav" aria-label="Activity">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Activity.Trace" class="md-nav__link">
    Trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.Activity.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics" class="md-nav__link">
    ProcessingQualityMetrics
  </a>
  
    <nav class="md-nav" aria-label="ProcessingQualityMetrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Mask" class="md-nav__link">
    Mask
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Trace" class="md-nav__link">
    Trace
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.make" class="md-nav__link">
    make()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#element_calcium_imaging.imaging_no_curation.get_loader_result" class="md-nav__link">
    get_loader_result()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../imaging_preprocess/" class="md-nav__link">
        imaging_preprocess.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../imaging_report/" class="md-nav__link">
        imaging_report.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_6" >
      
      
      
        <label class="md-nav__link" for="__nav_8_1_6" id="__nav_8_1_6_label" tabindex="0">
          plotting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_1_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_1_6">
          <span class="md-nav__icon md-icon"></span>
          plotting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/cell_plot/" class="md-nav__link">
        cell_plot.py
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/widget/" class="md-nav__link">
        widget.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scan/" class="md-nav__link">
        scan.py
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

        
        
        
        

  
  
  
    <li class="md-nav__item">
      <a href="../../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

        
    </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>imaging_no_curation.py</h1>

<div class="doc doc-object doc-module">


<a id="element_calcium_imaging.imaging_no_curation"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h2 id="element_calcium_imaging.imaging_no_curation.activate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">activate</span><span class="p">(</span><span class="n">imaging_schema_name</span><span class="p">,</span> <span class="n">scan_schema_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_tables</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linking_module</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.activate" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Activate this schema.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>imaging_schema_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Schema name on the database server to activate the
<code>imaging</code> module.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>scan_schema_name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Schema name on the database server to activate the
<code>scan</code> module. Omitted, if the <code>scan</code> module is already activated.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>create_schema</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>When True (default), create schema in the database if it
does not yet exist.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>create_tables</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>When True (default), create tables in the database if they
do not yet exist.</p>
            </div>
          </td>
          <td>
                <code>True</code>
          </td>
        </tr>
        <tr>
          <td><code>linking_module</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A module name or a module containing the required
dependencies to activate the <code>imaging</code> module: + all that are required by
the <code>scan</code> module.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>
      <p>Dependencies:</p>

<details class="upstream-tables" open>
  <summary>Upstream tables</summary>
  <ul>
<li>Session: A parent table to Scan, identifying a scanning session.</li>
<li>Equipment: A parent table to Scan, identifying a scanning device.</li>
</ul>
</details>
      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">activate</span><span class="p">(</span>
    <span class="n">imaging_schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">scan_schema_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">create_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">create_tables</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">linking_module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Activate this schema.</span>

<span class="sd">    Args:</span>
<span class="sd">        imaging_schema_name (str): Schema name on the database server to activate the</span>
<span class="sd">            `imaging` module.</span>
<span class="sd">        scan_schema_name (str): Schema name on the database server to activate the</span>
<span class="sd">            `scan` module. Omitted, if the `scan` module is already activated.</span>
<span class="sd">        create_schema (bool): When True (default), create schema in the database if it</span>
<span class="sd">            does not yet exist.</span>
<span class="sd">        create_tables (bool): When True (default), create tables in the database if they</span>
<span class="sd">            do not yet exist.</span>
<span class="sd">        linking_module (str): A module name or a module containing the required</span>
<span class="sd">            dependencies to activate the `imaging` module: + all that are required by</span>
<span class="sd">            the `scan` module.</span>

<span class="sd">    Dependencies:</span>
<span class="sd">    Upstream tables:</span>
<span class="sd">        + Session: A parent table to Scan, identifying a scanning session.</span>
<span class="sd">        + Equipment: A parent table to Scan, identifying a scanning device.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">linking_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">linking_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">linking_module</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span>
        <span class="n">linking_module</span>
    <span class="p">),</span> <span class="s2">&quot;The argument &#39;dependency&#39; must be a module&#39;s name or a module&quot;</span>

    <span class="k">global</span> <span class="n">_linking_module</span>
    <span class="n">_linking_module</span> <span class="o">=</span> <span class="n">linking_module</span>

    <span class="n">scan</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span>
        <span class="n">scan_schema_name</span><span class="p">,</span>
        <span class="n">create_schema</span><span class="o">=</span><span class="n">create_schema</span><span class="p">,</span>
        <span class="n">create_tables</span><span class="o">=</span><span class="n">create_tables</span><span class="p">,</span>
        <span class="n">linking_module</span><span class="o">=</span><span class="n">linking_module</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span>
        <span class="n">imaging_schema_name</span><span class="p">,</span>
        <span class="n">create_schema</span><span class="o">=</span><span class="n">create_schema</span><span class="p">,</span>
        <span class="n">create_tables</span><span class="o">=</span><span class="n">create_tables</span><span class="p">,</span>
        <span class="n">add_objects</span><span class="o">=</span><span class="n">_linking_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">imaging_report</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">imaging_schema_name</span><span class="si">}</span><span class="s2">_report&quot;</span><span class="p">,</span> <span class="n">imaging_schema_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="element_calcium_imaging.imaging_no_curation.get_imaging_root_data_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_imaging_root_data_dir</span><span class="p">()</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.get_imaging_root_data_dir" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Return imaging root data director(y/ies)</p>
<p>Retrieve the root data director(y/ies) containing the imaging data
for all subjects/sessions (e.g. acquired ScanImage raw files, output files from
processing routines, etc.). All data paths and directories in DataJoint Elements are
recommended to be stored as relative paths (posix format), with respect to some
user-configured "root" directory, which varies from machine to machine
(e.g. different mounted drive locations).</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dirs</code></td>          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of string(s) or Path(s) for the absolute paths of the imaging root data
director(y/ies).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/scan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_imaging_root_data_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return imaging root data director(y/ies)</span>

<span class="sd">    Retrieve the root data director(y/ies) containing the imaging data</span>
<span class="sd">    for all subjects/sessions (e.g. acquired ScanImage raw files, output files from</span>
<span class="sd">    processing routines, etc.). All data paths and directories in DataJoint Elements are</span>
<span class="sd">    recommended to be stored as relative paths (posix format), with respect to some</span>
<span class="sd">    user-configured &quot;root&quot; directory, which varies from machine to machine</span>
<span class="sd">    (e.g. different mounted drive locations).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dirs (list): A list of string(s) or Path(s) for the absolute paths of the imaging root data</span>
<span class="sd">            director(y/ies).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">root_directories</span> <span class="o">=</span> <span class="n">_linking_module</span><span class="o">.</span><span class="n">get_imaging_root_data_dir</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root_directories</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
        <span class="n">root_directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">root_directories</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_linking_module</span><span class="p">,</span> <span class="s2">&quot;get_processed_root_data_dir&quot;</span><span class="p">):</span>
        <span class="n">root_directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_linking_module</span><span class="o">.</span><span class="n">get_processed_root_data_dir</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">root_directories</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.ProcessingMethod" class="doc doc-heading">
        <code>ProcessingMethod</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingMethod" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Package used for processing of calcium imaging data (e.g. Suite2p, CaImAn, etc.).</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>processing_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Processing method.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>processing_method_desc</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Processing method description.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">ProcessingMethod</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Package used for processing of calcium imaging data (e.g. Suite2p, CaImAn, etc.).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        processing_method (str): Processing method.</span>
<span class="sd">        processing_method_desc (str): Processing method description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Package used for processing of calcium imaging data (e.g. Suite2p, CaImAn, etc.).</span>
<span class="s2">    processing_method: char(8)</span>
<span class="s2">    ---</span>
<span class="s2">    processing_method_desc: varchar(1000)  # Processing method description</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;suite2p&quot;</span><span class="p">,</span> <span class="s2">&quot;suite2p analysis suite&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;caiman&quot;</span><span class="p">,</span> <span class="s2">&quot;caiman analysis suite&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">,</span> <span class="s2">&quot;extract analysis suite&quot;</span><span class="p">),</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="element_calcium_imaging.imaging_no_curation.get_processed_root_data_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_processed_root_data_dir</span><span class="p">()</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.get_processed_root_data_dir" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the root directory for all processed data.</p>
<p>All data paths and directories in DataJoint Elements are recommended to be stored as
relative paths (posix format), with respect to some user-configured "root"
directory, which varies from machine to machine (e.g. different mounted drive
locations).</p>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dir</code></td>          <td>
                <code>str | pathlib.<span title="pathlib.Path">Path</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Absolute path of the processed imaging root data
directory.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/scan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_processed_root_data_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the root directory for all processed data.</span>

<span class="sd">    All data paths and directories in DataJoint Elements are recommended to be stored as</span>
<span class="sd">    relative paths (posix format), with respect to some user-configured &quot;root&quot;</span>
<span class="sd">    directory, which varies from machine to machine (e.g. different mounted drive</span>
<span class="sd">    locations).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dir (str| pathlib.Path): Absolute path of the processed imaging root data</span>
<span class="sd">            directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_linking_module</span><span class="p">,</span> <span class="s2">&quot;get_processed_root_data_dir&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_linking_module</span><span class="o">.</span><span class="n">get_processed_root_data_dir</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_imaging_root_data_dir</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.ProcessingParamSet" class="doc doc-heading">
        <code>ProcessingParamSet</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingParamSet" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Parameter set used for the processing of the calcium imaging scans,
including both the analysis suite and its respective input parameters.</p>
<p>A hash of the parameters of the analysis suite is also stored in order
to avoid duplicated entries.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>paramset_idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Unique parameter set ID.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ProcessingMethod</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A primary key from ProcessingMethod.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>paramset_desc</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameter set description.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>param_set_hash</code></td>
          <td>
                <code>uuid</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A universally unique identifier for the parameter set.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameter Set, a dictionary of all applicable parameters to
the analysis suite.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">ProcessingParamSet</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameter set used for the processing of the calcium imaging scans,</span>
<span class="sd">    including both the analysis suite and its respective input parameters.</span>

<span class="sd">    A hash of the parameters of the analysis suite is also stored in order</span>
<span class="sd">    to avoid duplicated entries.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        paramset_idx (int): Unique parameter set ID.</span>
<span class="sd">        ProcessingMethod (foreign key): A primary key from ProcessingMethod.</span>
<span class="sd">        paramset_desc (str): Parameter set description.</span>
<span class="sd">        param_set_hash (uuid): A universally unique identifier for the parameter set.</span>
<span class="sd">        params (longblob): Parameter Set, a dictionary of all applicable parameters to</span>
<span class="sd">            the analysis suite.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Processing Parameter Set</span>
<span class="s2">    paramset_idx: smallint  # Unique parameter set ID.</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; ProcessingMethod</span>
<span class="s2">    paramset_desc: varchar(1280)  # Parameter-set description</span>
<span class="s2">    param_set_hash: uuid  # A universally unique identifier for the parameter set</span>
<span class="s2">    unique index (param_set_hash)</span>
<span class="s2">    params: longblob  # Parameter Set, a dictionary of all applicable parameters to the analysis suite.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">insert_new_params</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">processing_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">paramset_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">paramset_desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Insert a parameter set into ProcessingParamSet table.</span>

<span class="sd">        This function automates the parameter set hashing and avoids insertion of an</span>
<span class="sd">            existing parameter set.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            processing_method (str): Processing method/package used for processing of</span>
<span class="sd">                calcium imaging.</span>
<span class="sd">            paramset_idx (int): Unique parameter set ID.</span>
<span class="sd">            paramset_desc (str): Parameter set description.</span>
<span class="sd">            params (dict): Parameter Set, all applicable parameters to the analysis</span>
<span class="sd">                suite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">processing_method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suite2p&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Please provide the processing parameters in the {&#39;suite2p&#39;: {...}, &#39;extract&#39;: {...}} dictionary format.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Force Suite2p to only run motion correction.</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;do_registration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;roidetect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;processing_method&quot;</span><span class="p">:</span> <span class="n">processing_method</span><span class="p">,</span>
            <span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">,</span>
            <span class="s2">&quot;paramset_desc&quot;</span><span class="p">:</span> <span class="n">paramset_desc</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s2">&quot;param_set_hash&quot;</span><span class="p">:</span> <span class="n">dict_to_uuid</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">q_param</span> <span class="o">=</span> <span class="bp">cls</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;param_set_hash&quot;</span><span class="p">:</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;param_set_hash&quot;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">q_param</span><span class="p">:</span>  <span class="c1"># If the specified param-set already exists</span>
            <span class="n">p_name</span> <span class="o">=</span> <span class="n">q_param</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="n">paramset_idx</span><span class="p">:</span>  <span class="c1"># If the existed set has the same name: job done</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># If not same name: human error, trying to add the same paramset with different name</span>
                <span class="k">raise</span> <span class="n">dj</span><span class="o">.</span><span class="n">DataJointError</span><span class="p">(</span>
                    <span class="s2">&quot;The specified param-set already exists - name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingParamSet.insert_new_params" class="doc doc-heading">
<code class="highlight language-python"><span class="n">insert_new_params</span><span class="p">(</span><span class="n">processing_method</span><span class="p">,</span> <span class="n">paramset_idx</span><span class="p">,</span> <span class="n">paramset_desc</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#element_calcium_imaging.imaging_no_curation.ProcessingParamSet.insert_new_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Insert a parameter set into ProcessingParamSet table.</p>
<p>This function automates the parameter set hashing and avoids insertion of an
    existing parameter set.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>processing_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Processing method/package used for processing of
calcium imaging.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>paramset_idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Unique parameter set ID.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>paramset_desc</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameter set description.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Parameter Set, all applicable parameters to the analysis
suite.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">insert_new_params</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">processing_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">paramset_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">paramset_desc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert a parameter set into ProcessingParamSet table.</span>

<span class="sd">    This function automates the parameter set hashing and avoids insertion of an</span>
<span class="sd">        existing parameter set.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        processing_method (str): Processing method/package used for processing of</span>
<span class="sd">            calcium imaging.</span>
<span class="sd">        paramset_idx (int): Unique parameter set ID.</span>
<span class="sd">        paramset_desc (str): Parameter set description.</span>
<span class="sd">        params (dict): Parameter Set, all applicable parameters to the analysis</span>
<span class="sd">            suite.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">processing_method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extract&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suite2p&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Please provide the processing parameters in the {&#39;suite2p&#39;: {...}, &#39;extract&#39;: {...}} dictionary format.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Force Suite2p to only run motion correction.</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;do_registration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;roidetect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;processing_method&quot;</span><span class="p">:</span> <span class="n">processing_method</span><span class="p">,</span>
        <span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">,</span>
        <span class="s2">&quot;paramset_desc&quot;</span><span class="p">:</span> <span class="n">paramset_desc</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="s2">&quot;param_set_hash&quot;</span><span class="p">:</span> <span class="n">dict_to_uuid</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">q_param</span> <span class="o">=</span> <span class="bp">cls</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;param_set_hash&quot;</span><span class="p">:</span> <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;param_set_hash&quot;</span><span class="p">]}</span>

    <span class="k">if</span> <span class="n">q_param</span><span class="p">:</span>  <span class="c1"># If the specified param-set already exists</span>
        <span class="n">p_name</span> <span class="o">=</span> <span class="n">q_param</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="n">paramset_idx</span><span class="p">:</span>  <span class="c1"># If the existed set has the same name: job done</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If not same name: human error, trying to add the same paramset with different name</span>
            <span class="k">raise</span> <span class="n">dj</span><span class="o">.</span><span class="n">DataJointError</span><span class="p">(</span>
                <span class="s2">&quot;The specified param-set already exists - name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_name</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="element_calcium_imaging.imaging_no_curation.get_image_files" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_image_files</span><span class="p">(</span><span class="n">scan_key</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.get_image_files" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the list of image files associated with a given Scan.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>scan_key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key of a Scan entry.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of full file paths.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/scan.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_image_files</span><span class="p">(</span><span class="n">scan_key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the list of image files associated with a given Scan.</span>

<span class="sd">    Args:</span>
<span class="sd">        scan_key: Primary key of a Scan entry.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of full file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_linking_module</span><span class="o">.</span><span class="n">get_image_files</span><span class="p">(</span><span class="n">scan_key</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.CellCompartment" class="doc doc-heading">
        <code>CellCompartment</code>


<a href="#element_calcium_imaging.imaging_no_curation.CellCompartment" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Cell compartments that can be imaged (e.g. 'axon', 'soma', etc.)</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>cell_compartment</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Cell compartment.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">CellCompartment</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cell compartments that can be imaged (e.g. &#39;axon&#39;, &#39;soma&#39;, etc.)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        cell_compartment (str): Cell compartment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Cell compartments</span>
<span class="s2">    cell_compartment: char(16)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;axon&quot;</span><span class="p">,</span> <span class="s2">&quot;soma&quot;</span><span class="p">,</span> <span class="s2">&quot;bouton&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.MaskType" class="doc doc-heading">
        <code>MaskType</code>


<a href="#element_calcium_imaging.imaging_no_curation.MaskType" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Available labels for segmented masks (e.g. 'soma', 'axon', 'dendrite', 'neuropil').</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>mask_type</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mask type.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">MaskType</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Available labels for segmented masks (e.g. &#39;soma&#39;, &#39;axon&#39;, &#39;dendrite&#39;, &#39;neuropil&#39;).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        mask_type (str): Mask type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Possible types of a segmented mask</span>
<span class="s2">    mask_type: varchar(16)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;soma&quot;</span><span class="p">,</span> <span class="s2">&quot;axon&quot;</span><span class="p">,</span> <span class="s2">&quot;dendrite&quot;</span><span class="p">,</span> <span class="s2">&quot;neuropil&quot;</span><span class="p">,</span> <span class="s2">&quot;artefact&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.ProcessingTask" class="doc doc-heading">
        <code>ProcessingTask</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Manual">Manual</span></code></p>

  
      <p>A pairing of processing params and scans to be loaded or triggered</p>
<p>This table defines a calcium imaging processing task for a combination of a
<code>Scan</code> and a <code>ProcessingParamSet</code> entries, including all the inputs (scan, method,
method's parameters). The task defined here is then run in the downstream table
<code>Processing</code>. This table supports definitions of both loading of pre-generated results
and the triggering of new analysis for all supported analysis methods.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>scan.Scan</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from scan.Scan.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ProcessingParamSet</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from ProcessingParamSet.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>processing_output_dir</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Output directory of the processed scan relative to the root data directory.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>task_mode</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>One of 'load' (load computed analysis results) or 'trigger'
(trigger computation).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">ProcessingTask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Manual</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A pairing of processing params and scans to be loaded or triggered</span>

<span class="sd">    This table defines a calcium imaging processing task for a combination of a</span>
<span class="sd">    `Scan` and a `ProcessingParamSet` entries, including all the inputs (scan, method,</span>
<span class="sd">    method&#39;s parameters). The task defined here is then run in the downstream table</span>
<span class="sd">    `Processing`. This table supports definitions of both loading of pre-generated results</span>
<span class="sd">    and the triggering of new analysis for all supported analysis methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        scan.Scan (foreign key): Primary key from scan.Scan.</span>
<span class="sd">        ProcessingParamSet (foreign key): Primary key from ProcessingParamSet.</span>
<span class="sd">        processing_output_dir (str): Output directory of the processed scan relative to the root data directory.</span>
<span class="sd">        task_mode (str): One of &#39;load&#39; (load computed analysis results) or &#39;trigger&#39;</span>
<span class="sd">            (trigger computation).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Manual table for defining a processing task ready to be run</span>
<span class="s2">    -&gt; scan.Scan</span>
<span class="s2">    -&gt; ProcessingParamSet</span>
<span class="s2">    ---</span>
<span class="s2">    processing_output_dir: varchar(255)  #  Output directory of the processed scan relative to root data directory</span>
<span class="s2">    task_mode=&#39;load&#39;: enum(&#39;load&#39;, &#39;trigger&#39;)  # &#39;load&#39;: load computed analysis results, &#39;trigger&#39;: trigger computation</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">infer_output_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer an output directory for an entry in ProcessingTask table.</span>

<span class="sd">        Args:</span>
<span class="sd">            key (dict): Primary key from the ProcessingTask table.</span>
<span class="sd">            relative (bool): If True, processing_output_dir is returned relative to</span>
<span class="sd">                imaging_root_dir. Default False.</span>
<span class="sd">            mkdir (bool): If True, create the processing_output_dir directory.</span>
<span class="sd">                Default True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dir (str): A default output directory for the processed results (processed_output_dir</span>
<span class="sd">                in ProcessingTask) based on the following convention:</span>
<span class="sd">                processed_dir / scan_dir / {processing_method}_{paramset_idx}</span>
<span class="sd">                e.g.: sub4/sess1/scan0/suite2p_0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acq_software</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">Scan</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;acq_software&quot;</span><span class="p">)</span>
        <span class="n">filetypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">ScanImage</span><span class="o">=</span><span class="s2">&quot;*.tif&quot;</span><span class="p">,</span> <span class="n">Scanbox</span><span class="o">=</span><span class="s2">&quot;*.sbx&quot;</span><span class="p">,</span> <span class="n">NIS</span><span class="o">=</span><span class="s2">&quot;*.nd2&quot;</span><span class="p">,</span> <span class="n">PrairieView</span><span class="o">=</span><span class="s2">&quot;*.tif&quot;</span>
        <span class="p">)</span>

        <span class="n">scan_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
            <span class="n">get_imaging_root_data_dir</span><span class="p">(),</span>
            <span class="n">get_image_files</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">acq_software</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="n">find_root_directory</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">scan_dir</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;processing_method&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">get_processed_root_data_dir</span><span class="p">())</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">processed_dir</span>
            <span class="o">/</span> <span class="n">scan_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">mkdir</span><span class="p">:</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">relative</span> <span class="k">else</span> <span class="n">output_dir</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scan_key</span><span class="p">,</span> <span class="n">paramset_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a ProcessingTask for a Scan using an parameter ProcessingParamSet</span>

<span class="sd">        Generate an entry in the ProcessingTask table for a particular scan using an</span>
<span class="sd">        existing parameter set from the ProcessingParamSet table.</span>

<span class="sd">        Args:</span>
<span class="sd">            scan_key (dict): Primary key from Scan table.</span>
<span class="sd">            paramset_idx (int): Unique parameter set ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">scan_key</span><span class="p">,</span> <span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">}</span>

        <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">get_processed_root_data_dir</span><span class="p">()</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">})</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;processing_method&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">suite2p_loader</span>

                <span class="n">suite2p_loader</span><span class="o">.</span><span class="n">Suite2p</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">caiman_loader</span>

                <span class="n">caiman_loader</span><span class="o">.</span><span class="n">CaImAn</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">extract_loader</span>

                <span class="n">extract_loader</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">task_mode</span> <span class="o">=</span> <span class="s2">&quot;trigger&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_mode</span> <span class="o">=</span> <span class="s2">&quot;load&quot;</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;processing_output_dir&quot;</span><span class="p">:</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span>
                    <span class="n">processed_dir</span>
                <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
                <span class="s2">&quot;task_mode&quot;</span><span class="p">:</span> <span class="n">task_mode</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">auto_generate_entries</span> <span class="o">=</span> <span class="n">generate</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingTask.infer_output_dir" class="doc doc-heading">
<code class="highlight language-python"><span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask.infer_output_dir" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Infer an output directory for an entry in ProcessingTask table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from the ProcessingTask table.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>relative</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, processing_output_dir is returned relative to
imaging_root_dir. Default False.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>mkdir</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If True, create the processing_output_dir directory.
Default True.</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>dir</code></td>          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A default output directory for the processed results (processed_output_dir
in ProcessingTask) based on the following convention:
processed_dir / scan_dir / {processing_method}_{paramset_idx}
e.g.: sub4/sess1/scan0/suite2p_0</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">infer_output_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer an output directory for an entry in ProcessingTask table.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): Primary key from the ProcessingTask table.</span>
<span class="sd">        relative (bool): If True, processing_output_dir is returned relative to</span>
<span class="sd">            imaging_root_dir. Default False.</span>
<span class="sd">        mkdir (bool): If True, create the processing_output_dir directory.</span>
<span class="sd">            Default True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dir (str): A default output directory for the processed results (processed_output_dir</span>
<span class="sd">            in ProcessingTask) based on the following convention:</span>
<span class="sd">            processed_dir / scan_dir / {processing_method}_{paramset_idx}</span>
<span class="sd">            e.g.: sub4/sess1/scan0/suite2p_0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acq_software</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">Scan</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;acq_software&quot;</span><span class="p">)</span>
    <span class="n">filetypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">ScanImage</span><span class="o">=</span><span class="s2">&quot;*.tif&quot;</span><span class="p">,</span> <span class="n">Scanbox</span><span class="o">=</span><span class="s2">&quot;*.sbx&quot;</span><span class="p">,</span> <span class="n">NIS</span><span class="o">=</span><span class="s2">&quot;*.nd2&quot;</span><span class="p">,</span> <span class="n">PrairieView</span><span class="o">=</span><span class="s2">&quot;*.tif&quot;</span>
    <span class="p">)</span>

    <span class="n">scan_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span>
        <span class="n">get_imaging_root_data_dir</span><span class="p">(),</span>
        <span class="n">get_image_files</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">filetypes</span><span class="p">[</span><span class="n">acq_software</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">find_root_directory</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">scan_dir</span><span class="p">)</span>

    <span class="n">method</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;processing_method&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">get_processed_root_data_dir</span><span class="p">())</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">processed_dir</span>
        <span class="o">/</span> <span class="n">scan_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
        <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">mkdir</span><span class="p">:</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">processed_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">relative</span> <span class="k">else</span> <span class="n">output_dir</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingTask.generate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">generate</span><span class="p">(</span><span class="n">scan_key</span><span class="p">,</span> <span class="n">paramset_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#element_calcium_imaging.imaging_no_curation.ProcessingTask.generate" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Generate a ProcessingTask for a Scan using an parameter ProcessingParamSet</p>
<p>Generate an entry in the ProcessingTask table for a particular scan using an
existing parameter set from the ProcessingParamSet table.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>scan_key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Scan table.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>paramset_idx</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Unique parameter set ID.</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scan_key</span><span class="p">,</span> <span class="n">paramset_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a ProcessingTask for a Scan using an parameter ProcessingParamSet</span>

<span class="sd">    Generate an entry in the ProcessingTask table for a particular scan using an</span>
<span class="sd">    existing parameter set from the ProcessingParamSet table.</span>

<span class="sd">    Args:</span>
<span class="sd">        scan_key (dict): Primary key from Scan table.</span>
<span class="sd">        paramset_idx (int): Unique parameter set ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">scan_key</span><span class="p">,</span> <span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">}</span>

    <span class="n">processed_dir</span> <span class="o">=</span> <span class="n">get_processed_root_data_dir</span><span class="p">()</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">method</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s2">&quot;paramset_idx&quot;</span><span class="p">:</span> <span class="n">paramset_idx</span><span class="p">})</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;processing_method&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">suite2p_loader</span>

            <span class="n">suite2p_loader</span><span class="o">.</span><span class="n">Suite2p</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">caiman_loader</span>

            <span class="n">caiman_loader</span><span class="o">.</span><span class="n">CaImAn</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">extract_loader</span>

            <span class="n">extract_loader</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">task_mode</span> <span class="o">=</span> <span class="s2">&quot;trigger&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">task_mode</span> <span class="o">=</span> <span class="s2">&quot;load&quot;</span>

    <span class="bp">cls</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
            <span class="s2">&quot;processing_output_dir&quot;</span><span class="p">:</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span>
                <span class="n">processed_dir</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">:</span> <span class="n">task_mode</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.Processing" class="doc doc-heading">
        <code>Processing</code>


<a href="#element_calcium_imaging.imaging_no_curation.Processing" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Perform the computation of an entry (task) defined in the ProcessingTask table.
The computation is performed only on the scans with ScanInfo inserted.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ProcessingTask</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from ProcessingTask.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>processing_time</code></td>
          <td>
                <code>datetime</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Process completion datetime.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>package_version</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Version of the analysis package used in
processing the data.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Processing</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform the computation of an entry (task) defined in the ProcessingTask table.</span>
<span class="sd">    The computation is performed only on the scans with ScanInfo inserted.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ProcessingTask (foreign key): Primary key from ProcessingTask.</span>
<span class="sd">        processing_time (datetime): Process completion datetime.</span>
<span class="sd">        package_version (str, optional): Version of the analysis package used in</span>
<span class="sd">            processing the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; ProcessingTask</span>
<span class="s2">    ---</span>
<span class="s2">    processing_time     : datetime  # Time of generation of this set of processed, segmented results</span>
<span class="s2">    package_version=&#39;&#39;  : varchar(16)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># Run processing only on Scan with ScanInfo inserted</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Limit the Processing to Scans that have their metadata ingested to the</span>
<span class="sd">        database.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the calcium imaging analysis defined by the ProcessingTask.&quot;&quot;&quot;</span>

        <span class="n">task_mode</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;processing_output_dir&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ProcessingTask</span><span class="o">.</span><span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># update processing_output_dir</span>
            <span class="n">ProcessingTask</span><span class="o">.</span><span class="n">update1</span><span class="p">(</span>
                <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_output_dir&quot;</span><span class="p">:</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()}</span>
            <span class="p">)</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;nrois&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s2">&quot;Suite2p ingestion error - Unable to handle&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot; ScanImage multi-ROI scanning mode yet&quot;</span>
                    <span class="p">)</span>
                <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
                <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;To use EXTRACT with this DataJoint Element please set `task_mode=trigger`&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;processing_method&quot;</span>
            <span class="p">)</span>

            <span class="n">image_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">ScanFile</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">)</span>
            <span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">find_full_path</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">image_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_files</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">suite2p</span>

                <span class="n">suite2p_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                    <span class="s2">&quot;params&quot;</span>
                <span class="p">)</span>
                <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;save_path0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>
                <span class="p">(</span>
                    <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">],</span>
                    <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;nplanes&quot;</span><span class="p">],</span>
                    <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;nchannels&quot;</span><span class="p">],</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span><span class="p">)</span>

                <span class="n">input_format</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span>
                <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;input_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="n">suite2p_paths</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
                    <span class="s2">&quot;tiff_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
                <span class="p">}</span>

                <span class="n">suite2p</span><span class="o">.</span><span class="n">run_s2p</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="n">suite2p_params</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">suite2p_paths</span><span class="p">)</span>  <span class="c1"># Run suite2p</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
                <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">element_interface.caiman_loader</span> <span class="kn">import</span> <span class="n">_process_scanimage_tiff</span>
                <span class="kn">from</span> <span class="nn">element_interface.run_caiman</span> <span class="kn">import</span> <span class="n">run_caiman</span>

                <span class="n">caiman_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                    <span class="s2">&quot;params&quot;</span>
                <span class="p">)</span>
                <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">ndepths</span><span class="p">,</span> <span class="n">nchannels</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                    <span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span>
                <span class="p">)</span>

                <span class="n">is3D</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ndepths</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is3D</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s2">&quot;Caiman pipeline is not yet capable of analyzing 3D scans.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># handle multi-channel tiff image before running CaImAn</span>
                <span class="k">if</span> <span class="n">nchannels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">channel_idx</span> <span class="o">=</span> <span class="n">caiman_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel_to_process&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;channel_separated_tif&quot;</span>
                    <span class="n">tmp_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">_process_scanimage_tiff</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">tmp_dir</span>
                    <span class="p">)</span>
                    <span class="n">image_files</span> <span class="o">=</span> <span class="n">tmp_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*_chn</span><span class="si">{</span><span class="n">channel_idx</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

                <span class="n">run_caiman</span><span class="p">(</span>
                    <span class="n">file_paths</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="n">caiman_params</span><span class="p">,</span>
                    <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                    <span class="n">is3D</span><span class="o">=</span><span class="n">is3D</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
                <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;processing_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">creation_time</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">suite2p</span>
                <span class="kn">from</span> <span class="nn">element_interface.extract_trigger</span> <span class="kn">import</span> <span class="n">EXTRACT_trigger</span>
                <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">savemat</span>

                <span class="c1"># Motion Correction with Suite2p</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>

                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;save_path0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>
                <span class="p">(</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;fs&quot;</span><span class="p">],</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;nplanes&quot;</span><span class="p">],</span>
                    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;nchannels&quot;</span><span class="p">],</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span><span class="p">)</span>

                <span class="n">input_format</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;input_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                <span class="n">suite2p_paths</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
                    <span class="s2">&quot;tiff_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
                <span class="p">}</span>

                <span class="n">suite2p</span><span class="o">.</span><span class="n">run_s2p</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">],</span> <span class="n">db</span><span class="o">=</span><span class="n">suite2p_paths</span><span class="p">)</span>

                <span class="c1"># Convert data.bin to registered_scans.mat</span>
                <span class="n">scanfile_fullpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;suite2p/plane0/data.bin&quot;</span>

                <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                    <span class="s2">&quot;nframes&quot;</span><span class="p">,</span> <span class="s2">&quot;px_height&quot;</span><span class="p">,</span> <span class="s2">&quot;px_width&quot;</span>
                <span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">scanfile_fullpath</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

                <span class="n">scan_matlab_fullpath</span> <span class="o">=</span> <span class="n">scanfile_fullpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;registered_scan.mat&quot;</span>

                <span class="c1"># Save the motion corrected movie (data.bin) in a .mat file</span>
                <span class="n">savemat</span><span class="p">(</span>
                    <span class="n">scan_matlab_fullpath</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])},</span>
                <span class="p">)</span>

                <span class="c1"># Execute EXTRACT</span>

                <span class="n">ex</span> <span class="o">=</span> <span class="n">EXTRACT_trigger</span><span class="p">(</span>
                    <span class="n">scan_matlab_fullpath</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">],</span> <span class="n">output_dir</span>
                <span class="p">)</span>
                <span class="n">ex</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
                <span class="n">key</span><span class="p">[</span><span class="s2">&quot;processing_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_dataset</span><span class="o">.</span><span class="n">creation_time</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown task mode: </span><span class="si">{</span><span class="n">task_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="element_calcium_imaging.imaging_no_curation.Processing.key_source" class="doc doc-heading">
<code class="highlight language-python"><span class="n">key_source</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#element_calcium_imaging.imaging_no_curation.Processing.key_source" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Limit the Processing to Scans that have their metadata ingested to the
database.</p>
  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.Processing.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.Processing.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Execute the calcium imaging analysis defined by the ProcessingTask.</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the calcium imaging analysis defined by the ProcessingTask.&quot;&quot;&quot;</span>

    <span class="n">task_mode</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;task_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;processing_output_dir&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">ProcessingTask</span><span class="o">.</span><span class="n">infer_output_dir</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mkdir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># update processing_output_dir</span>
        <span class="n">ProcessingTask</span><span class="o">.</span><span class="n">update1</span><span class="p">(</span>
            <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_output_dir&quot;</span><span class="p">:</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()}</span>
        <span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">output_dir</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;load&quot;</span><span class="p">:</span>
        <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;nrois&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Suite2p ingestion error - Unable to handle&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot; ScanImage multi-ROI scanning mode yet&quot;</span>
                <span class="p">)</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;To use EXTRACT with this DataJoint Element please set `task_mode=trigger`&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">task_mode</span> <span class="o">==</span> <span class="s2">&quot;trigger&quot;</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
            <span class="s2">&quot;processing_method&quot;</span>
        <span class="p">)</span>

        <span class="n">image_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">ScanFile</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">)</span>
        <span class="n">image_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">find_full_path</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">image_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_files</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">suite2p</span>

            <span class="n">suite2p_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;params&quot;</span>
            <span class="p">)</span>
            <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;save_path0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>
            <span class="p">(</span>
                <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;fs&quot;</span><span class="p">],</span>
                <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;nplanes&quot;</span><span class="p">],</span>
                <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;nchannels&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span><span class="p">)</span>

            <span class="n">input_format</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span>
            <span class="n">suite2p_params</span><span class="p">[</span><span class="s2">&quot;input_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">suite2p_paths</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
                <span class="s2">&quot;tiff_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="n">suite2p</span><span class="o">.</span><span class="n">run_s2p</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="n">suite2p_params</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">suite2p_paths</span><span class="p">)</span>  <span class="c1"># Run suite2p</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;processing_time&quot;</span><span class="p">:</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">creation_time</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">element_interface.caiman_loader</span> <span class="kn">import</span> <span class="n">_process_scanimage_tiff</span>
            <span class="kn">from</span> <span class="nn">element_interface.run_caiman</span> <span class="kn">import</span> <span class="n">run_caiman</span>

            <span class="n">caiman_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;params&quot;</span>
            <span class="p">)</span>
            <span class="n">sampling_rate</span><span class="p">,</span> <span class="n">ndepths</span><span class="p">,</span> <span class="n">nchannels</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span>
            <span class="p">)</span>

            <span class="n">is3D</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ndepths</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is3D</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Caiman pipeline is not yet capable of analyzing 3D scans.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># handle multi-channel tiff image before running CaImAn</span>
            <span class="k">if</span> <span class="n">nchannels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">channel_idx</span> <span class="o">=</span> <span class="n">caiman_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;channel_to_process&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;channel_separated_tif&quot;</span>
                <span class="n">tmp_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_process_scanimage_tiff</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">tmp_dir</span>
                <span class="p">)</span>
                <span class="n">image_files</span> <span class="o">=</span> <span class="n">tmp_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*_chn</span><span class="si">{</span><span class="n">channel_idx</span><span class="si">}</span><span class="s2">.tif&quot;</span><span class="p">)</span>

            <span class="n">run_caiman</span><span class="p">(</span>
                <span class="n">file_paths</span><span class="o">=</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
                <span class="n">parameters</span><span class="o">=</span><span class="n">caiman_params</span><span class="p">,</span>
                <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">is3D</span><span class="o">=</span><span class="n">is3D</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;processing_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">creation_time</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">suite2p</span>
            <span class="kn">from</span> <span class="nn">element_interface.extract_trigger</span> <span class="kn">import</span> <span class="n">EXTRACT_trigger</span>
            <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">savemat</span>

            <span class="c1"># Motion Correction with Suite2p</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingTask</span> <span class="o">*</span> <span class="n">ProcessingParamSet</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>

            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;save_path0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dir</span>
            <span class="p">(</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;fs&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;nplanes&quot;</span><span class="p">],</span>
                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;nchannels&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;fps&quot;</span><span class="p">,</span> <span class="s2">&quot;ndepths&quot;</span><span class="p">,</span> <span class="s2">&quot;nchannels&quot;</span><span class="p">)</span>

            <span class="n">input_format</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">][</span><span class="s2">&quot;input_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_format</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">suite2p_paths</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">image_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()],</span>
                <span class="s2">&quot;tiff_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">],</span>
            <span class="p">}</span>

            <span class="n">suite2p</span><span class="o">.</span><span class="n">run_s2p</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">],</span> <span class="n">db</span><span class="o">=</span><span class="n">suite2p_paths</span><span class="p">)</span>

            <span class="c1"># Convert data.bin to registered_scans.mat</span>
            <span class="n">scanfile_fullpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;suite2p/plane0/data.bin&quot;</span>

            <span class="n">data_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
                <span class="s2">&quot;nframes&quot;</span><span class="p">,</span> <span class="s2">&quot;px_height&quot;</span><span class="p">,</span> <span class="s2">&quot;px_width&quot;</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">scanfile_fullpath</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

            <span class="n">scan_matlab_fullpath</span> <span class="o">=</span> <span class="n">scanfile_fullpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;registered_scan.mat&quot;</span>

            <span class="c1"># Save the motion corrected movie (data.bin) in a .mat file</span>
            <span class="n">savemat</span><span class="p">(</span>
                <span class="n">scan_matlab_fullpath</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])},</span>
            <span class="p">)</span>

            <span class="c1"># Execute EXTRACT</span>

            <span class="n">ex</span> <span class="o">=</span> <span class="n">EXTRACT_trigger</span><span class="p">(</span>
                <span class="n">scan_matlab_fullpath</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;extract&quot;</span><span class="p">],</span> <span class="n">output_dir</span>
            <span class="p">)</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>
            <span class="n">key</span><span class="p">[</span><span class="s2">&quot;processing_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_dataset</span><span class="o">.</span><span class="n">creation_time</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown task mode: </span><span class="si">{</span><span class="n">task_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.MotionCorrection" class="doc doc-heading">
        <code>MotionCorrection</code>


<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Imported">Imported</span></code></p>

  
      <p>Results of motion correction shifts performed on the imaging data.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Processing</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Processing.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>scan.Channel.proj(motion_correct_channel=&#39;channel&#39;)</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Channel used for
motion correction in this processing task.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">MotionCorrection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Imported</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Results of motion correction shifts performed on the imaging data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Processing (foreign key): Primary key from Processing.</span>
<span class="sd">        scan.Channel.proj(motion_correct_channel=&#39;channel&#39;) (int): Channel used for</span>
<span class="sd">            motion correction in this processing task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Results of motion correction</span>
<span class="s2">    -&gt; Processing</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; scan.Channel.proj(motion_correct_channel=&#39;channel&#39;) # channel used for motion correction in this processing task</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">RigidMotionCorrection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Details of rigid motion correction performed on the imaging data.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">            outlier_frames (longblob): Mask with true for frames with outlier shifts</span>
<span class="sd">                (already corrected).</span>
<span class="sd">            y_shifts (longblob): y motion correction shifts (pixels).</span>
<span class="sd">            x_shifts (longblob): x motion correction shifts (pixels).</span>
<span class="sd">            z_shifts (longblob, optional): z motion correction shifts (z-drift, pixels).</span>
<span class="sd">            y_std (float): standard deviation of y shifts across all frames (pixels).</span>
<span class="sd">            x_std (float): standard deviation of x shifts across all frames (pixels).</span>
<span class="sd">            z_std (float, optional): standard deviation of z shifts across all frames</span>
<span class="sd">                (pixels).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Details of rigid motion correction performed on the imaging data</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        ---</span>
<span class="s2">        outlier_frames=null : longblob  # mask with true for frames with outlier shifts (already corrected)</span>
<span class="s2">        y_shifts            : longblob  # (pixels) y motion correction shifts</span>
<span class="s2">        x_shifts            : longblob  # (pixels) x motion correction shifts</span>
<span class="s2">        z_shifts=null       : longblob  # (pixels) z motion correction shifts (z-drift)</span>
<span class="s2">        y_std               : float     # (pixels) standard deviation of y shifts across all frames</span>
<span class="s2">        x_std               : float     # (pixels) standard deviation of x shifts across all frames</span>
<span class="s2">        z_std=null          : float     # (pixels) standard deviation of z shifts across all frames</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">NonRigidMotionCorrection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Piece-wise rigid motion correction - tile the FOV into multiple 3D</span>
<span class="sd">        blocks/patches.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">            outlier_frames (longblob, null): Mask with true for frames with outlier</span>
<span class="sd">                shifts (already corrected).</span>
<span class="sd">            block_height (int): Block height in pixels.</span>
<span class="sd">            block_width (int): Block width in pixels.</span>
<span class="sd">            block_depth (int): Block depth in pixels.</span>
<span class="sd">            block_count_y (int): Number of blocks tiled in the y direction.</span>
<span class="sd">            block_count_x (int): Number of blocks tiled in the x direction.</span>
<span class="sd">            block_count_z (int): Number of blocks tiled in the z direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Details of non-rigid motion correction performed on the imaging data</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        ---</span>
<span class="s2">        outlier_frames=null : longblob # mask with true for frames with outlier shifts (already corrected)</span>
<span class="s2">        block_height        : int      # (pixels)</span>
<span class="s2">        block_width         : int      # (pixels)</span>
<span class="s2">        block_depth         : int      # (pixels)</span>
<span class="s2">        block_count_y       : int      # number of blocks tiled in the y direction</span>
<span class="s2">        block_count_x       : int      # number of blocks tiled in the x direction</span>
<span class="s2">        block_count_z       : int      # number of blocks tiled in the z direction</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;FOV-tiled blocks used for non-rigid motion correction.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            NonRigidMotionCorrection (foreign key): Primary key from</span>
<span class="sd">                NonRigidMotionCorrection.</span>
<span class="sd">            block_id (int): Unique block ID.</span>
<span class="sd">            block_y (longblob): y_start and y_end in pixels for this block</span>
<span class="sd">            block_x (longblob): x_start and x_end in pixels for this block</span>
<span class="sd">            block_z (longblob): z_start and z_end in pixels for this block</span>
<span class="sd">            y_shifts (longblob): y motion correction shifts for every frame in pixels</span>
<span class="sd">            x_shifts (longblob): x motion correction shifts for every frame in pixels</span>
<span class="sd">            z_shift=null (longblob, optional): x motion correction shifts for every frame</span>
<span class="sd">                in pixels</span>
<span class="sd">            y_std (float): standard deviation of y shifts across all frames in pixels</span>
<span class="sd">            x_std (float): standard deviation of x shifts across all frames in pixels</span>
<span class="sd">            z_std=null (float, optional): standard deviation of z shifts across all frames</span>
<span class="sd">                in pixels</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# FOV-tiled blocks used for non-rigid motion correction</span>
<span class="s2">        -&gt; master.NonRigidMotionCorrection</span>
<span class="s2">        block_id        : int</span>
<span class="s2">        ---</span>
<span class="s2">        block_y         : longblob  # (y_start, y_end) in pixel of this block</span>
<span class="s2">        block_x         : longblob  # (x_start, x_end) in pixel of this block</span>
<span class="s2">        block_z         : longblob  # (z_start, z_end) in pixel of this block</span>
<span class="s2">        y_shifts        : longblob  # (pixels) y motion correction shifts for every frame</span>
<span class="s2">        x_shifts        : longblob  # (pixels) x motion correction shifts for every frame</span>
<span class="s2">        z_shifts=null   : longblob  # (pixels) x motion correction shifts for every frame</span>
<span class="s2">        y_std           : float     # (pixels) standard deviation of y shifts across all frames</span>
<span class="s2">        x_std           : float     # (pixels) standard deviation of x shifts across all frames</span>
<span class="s2">        z_std=null      : float     # (pixels) standard deviation of z shifts across all frames</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Summary</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summary images for each field and channel after corrections.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">            scan.ScanInfo.Field (foreign key): Primary key from scan.ScanInfo.Field.</span>
<span class="sd">            ref_image (longblob): Image used as alignment template.</span>
<span class="sd">            average_image (longblob): Mean of registered frames.</span>
<span class="sd">            correlation_image (longblob, optional): Correlation map (computed during</span>
<span class="sd">                cell detection).</span>
<span class="sd">            max_proj_image (longblob, optional): Max of registered frames.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Summary images for each field and channel after corrections</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; scan.ScanInfo.Field</span>
<span class="s2">        ---</span>
<span class="s2">        ref_image               : longblob  # image used as alignment template</span>
<span class="s2">        average_image           : longblob  # mean of registered frames</span>
<span class="s2">        correlation_image=null  : longblob  # correlation map (computed during cell detection)</span>
<span class="s2">        max_proj_image=null     : longblob  # max of registered frames</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate MotionCorrection with results parsed from analysis outputs&quot;&quot;&quot;</span>

        <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

        <span class="n">field_keys</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="s2">&quot;KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;field_z&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;field_z&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">,</span> <span class="s2">&quot;extract&quot;</span><span class="p">]:</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="n">motion_correct_channel</span> <span class="o">=</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alignment_channel</span>

            <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
            <span class="n">rigid_correction</span><span class="p">,</span> <span class="n">nonrigid_correction</span><span class="p">,</span> <span class="n">nonrigid_blocks</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="n">summary_images</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">s2p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># -- rigid motion correction --</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                        <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">]]</span>
                    <span class="p">)</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                        <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">]]</span>
                    <span class="p">)</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                        <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                        <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># -- non-rigid motion correction --</span>
                <span class="k">if</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nonrigid&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nonrigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;block_height&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;block_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;block_width&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;block_size&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;block_depth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;block_count_y&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nblocks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;block_count_x&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nblocks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;block_count_z&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">),</span>
                            <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nonrigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                            <span class="n">nonrigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">],</span>
                            <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="k">for</span> <span class="n">b_id</span><span class="p">,</span> <span class="p">(</span><span class="n">b_y</span><span class="p">,</span> <span class="n">b_x</span><span class="p">,</span> <span class="n">bshift_y</span><span class="p">,</span> <span class="n">bshift_x</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span>
                            <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xblock&quot;</span><span class="p">],</span>
                            <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yblock&quot;</span><span class="p">],</span>
                            <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                            <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">b_id</span> <span class="ow">in</span> <span class="n">nonrigid_blocks</span><span class="p">:</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">],</span> <span class="n">bshift_y</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="p">)</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">],</span> <span class="n">bshift_x</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                                <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="n">b_id</span><span class="p">,</span>
                                <span class="s2">&quot;block_y&quot;</span><span class="p">:</span> <span class="n">b_y</span><span class="p">,</span>
                                <span class="s2">&quot;block_x&quot;</span><span class="p">:</span> <span class="n">b_x</span><span class="p">,</span>
                                <span class="s2">&quot;block_z&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">b_x</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                                <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">bshift_y</span><span class="p">,</span>
                                <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">bshift_x</span><span class="p">,</span>
                                <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">),</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">bshift_x</span><span class="p">),</span>
                                    <span class="p">),</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bshift_y</span><span class="p">),</span>
                                <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bshift_x</span><span class="p">),</span>
                                <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                            <span class="p">}</span>

                <span class="c1"># -- summary images --</span>
                <span class="n">motion_correction_key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">*</span> <span class="n">Processing</span> <span class="o">&amp;</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="n">field_keys</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
                <span class="n">summary_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">motion_correction_key</span><span class="p">,</span>
                        <span class="s2">&quot;ref_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ref_image</span><span class="p">,</span>
                        <span class="s2">&quot;average_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">mean_image</span><span class="p">,</span>
                        <span class="s2">&quot;correlation_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">correlation_map</span><span class="p">,</span>
                        <span class="s2">&quot;max_proj_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">max_proj_image</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;motion_correct_channel&quot;</span><span class="p">:</span> <span class="n">motion_correct_channel</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">rigid_correction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">RigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">rigid_correction</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nonrigid_correction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NonRigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">nonrigid_correction</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Block</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nonrigid_blocks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">summary_images</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;motion_correct_channel&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">alignment_channel</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="n">is3D</span> <span class="o">=</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;is3D&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;pw_rigid&quot;</span><span class="p">]:</span>
                <span class="c1"># -- rigid motion correction --</span>
                <span class="n">rigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">is3D</span>
                        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                            <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">is3D</span>
                        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">RigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">rigid_correction</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># -- non-rigid motion correction --</span>
                <span class="n">nonrigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;block_height&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;block_width&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;block_depth&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">is3D</span>
                        <span class="k">else</span> <span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;block_count_x&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;block_count_y&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;block_count_z&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span>
                            <span class="nb">set</span><span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="mi">4</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">is3D</span>
                        <span class="k">else</span> <span class="mi">1</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="n">nonrigid_blocks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">b_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">):</span>
                    <span class="n">nonrigid_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="n">b_id</span><span class="p">,</span>
                            <span class="s2">&quot;block_x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="n">b_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span>
                                <span class="p">]</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;block_y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="n">b_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span>
                                <span class="p">]</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;block_z&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                    <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                        <span class="s2">&quot;coord_shifts_els&quot;</span>
                                    <span class="p">][</span><span class="n">b_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">is3D</span>
                                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                        <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                            <span class="s2">&quot;coord_shifts_els&quot;</span>
                                        <span class="p">][</span><span class="n">b_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                                    <span class="p">),</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                <span class="s2">&quot;x_shifts_els&quot;</span>
                            <span class="p">][:,</span> <span class="n">b_id</span><span class="p">],</span>
                            <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                <span class="s2">&quot;y_shifts_els&quot;</span>
                            <span class="p">][:,</span> <span class="n">b_id</span><span class="p">],</span>
                            <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;z_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="n">b_id</span>
                                <span class="p">]</span>
                                <span class="k">if</span> <span class="n">is3D</span>
                                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span>
                                        <span class="p">:,</span> <span class="n">b_id</span>
                                    <span class="p">],</span>
                                    <span class="mi">0</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="n">b_id</span>
                                <span class="p">]</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="n">b_id</span>
                                <span class="p">]</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;z_shifts_els&quot;</span><span class="p">][</span>
                                        <span class="p">:,</span> <span class="n">b_id</span>
                                    <span class="p">]</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">is3D</span>
                                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="p">),</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">NonRigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">nonrigid_correction</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Block</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nonrigid_blocks</span><span class="p">)</span>

            <span class="c1"># -- summary images --</span>
            <span class="n">summary_images</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">fkey</span><span class="p">,</span>
                    <span class="s2">&quot;ref_image&quot;</span><span class="p">:</span> <span class="n">ref_image</span><span class="p">,</span>
                    <span class="s2">&quot;average_image&quot;</span><span class="p">:</span> <span class="n">ave_img</span><span class="p">,</span>
                    <span class="s2">&quot;correlation_image&quot;</span><span class="p">:</span> <span class="n">corr_img</span><span class="p">,</span>
                    <span class="s2">&quot;max_proj_image&quot;</span><span class="p">:</span> <span class="n">max_img</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">ref_image</span><span class="p">,</span> <span class="n">ave_img</span><span class="p">,</span> <span class="n">corr_img</span><span class="p">,</span> <span class="n">max_img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">field_keys</span><span class="p">,</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;reference_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;reference_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                    <span class="p">],</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;average_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;average_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                    <span class="p">],</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;correlation_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;correlation_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                    <span class="p">],</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;max_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;max_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                    <span class="p">],</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">summary_images</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.MotionCorrection.RigidMotionCorrection" class="doc doc-heading">
        <code>RigidMotionCorrection</code>


<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.RigidMotionCorrection" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Details of rigid motion correction performed on the imaging data.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>MotionCorrection</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from MotionCorrection.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>outlier_frames</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mask with true for frames with outlier shifts
(already corrected).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>y_shifts</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>y motion correction shifts (pixels).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>x_shifts</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>x motion correction shifts (pixels).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>z_shifts</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>z motion correction shifts (z-drift, pixels).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>y_std</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of y shifts across all frames (pixels).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>x_std</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of x shifts across all frames (pixels).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>z_std</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of z shifts across all frames
(pixels).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RigidMotionCorrection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details of rigid motion correction performed on the imaging data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">        outlier_frames (longblob): Mask with true for frames with outlier shifts</span>
<span class="sd">            (already corrected).</span>
<span class="sd">        y_shifts (longblob): y motion correction shifts (pixels).</span>
<span class="sd">        x_shifts (longblob): x motion correction shifts (pixels).</span>
<span class="sd">        z_shifts (longblob, optional): z motion correction shifts (z-drift, pixels).</span>
<span class="sd">        y_std (float): standard deviation of y shifts across all frames (pixels).</span>
<span class="sd">        x_std (float): standard deviation of x shifts across all frames (pixels).</span>
<span class="sd">        z_std (float, optional): standard deviation of z shifts across all frames</span>
<span class="sd">            (pixels).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Details of rigid motion correction performed on the imaging data</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    ---</span>
<span class="s2">    outlier_frames=null : longblob  # mask with true for frames with outlier shifts (already corrected)</span>
<span class="s2">    y_shifts            : longblob  # (pixels) y motion correction shifts</span>
<span class="s2">    x_shifts            : longblob  # (pixels) x motion correction shifts</span>
<span class="s2">    z_shifts=null       : longblob  # (pixels) z motion correction shifts (z-drift)</span>
<span class="s2">    y_std               : float     # (pixels) standard deviation of y shifts across all frames</span>
<span class="s2">    x_std               : float     # (pixels) standard deviation of x shifts across all frames</span>
<span class="s2">    z_std=null          : float     # (pixels) standard deviation of z shifts across all frames</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.MotionCorrection.NonRigidMotionCorrection" class="doc doc-heading">
        <code>NonRigidMotionCorrection</code>


<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.NonRigidMotionCorrection" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Piece-wise rigid motion correction - tile the FOV into multiple 3D
blocks/patches.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>MotionCorrection</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from MotionCorrection.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>outlier_frames</code></td>
          <td>
                <code>longblob, null</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mask with true for frames with outlier
shifts (already corrected).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_height</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Block height in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_width</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Block width in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_depth</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Block depth in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_count_y</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of blocks tiled in the y direction.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_count_x</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of blocks tiled in the x direction.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_count_z</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of blocks tiled in the z direction.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">NonRigidMotionCorrection</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Piece-wise rigid motion correction - tile the FOV into multiple 3D</span>
<span class="sd">    blocks/patches.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">        outlier_frames (longblob, null): Mask with true for frames with outlier</span>
<span class="sd">            shifts (already corrected).</span>
<span class="sd">        block_height (int): Block height in pixels.</span>
<span class="sd">        block_width (int): Block width in pixels.</span>
<span class="sd">        block_depth (int): Block depth in pixels.</span>
<span class="sd">        block_count_y (int): Number of blocks tiled in the y direction.</span>
<span class="sd">        block_count_x (int): Number of blocks tiled in the x direction.</span>
<span class="sd">        block_count_z (int): Number of blocks tiled in the z direction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Details of non-rigid motion correction performed on the imaging data</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    ---</span>
<span class="s2">    outlier_frames=null : longblob # mask with true for frames with outlier shifts (already corrected)</span>
<span class="s2">    block_height        : int      # (pixels)</span>
<span class="s2">    block_width         : int      # (pixels)</span>
<span class="s2">    block_depth         : int      # (pixels)</span>
<span class="s2">    block_count_y       : int      # number of blocks tiled in the y direction</span>
<span class="s2">    block_count_x       : int      # number of blocks tiled in the x direction</span>
<span class="s2">    block_count_z       : int      # number of blocks tiled in the z direction</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.MotionCorrection.Block" class="doc doc-heading">
        <code>Block</code>


<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.Block" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>FOV-tiled blocks used for non-rigid motion correction.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>NonRigidMotionCorrection</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from
NonRigidMotionCorrection.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Unique block ID.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_y</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>y_start and y_end in pixels for this block</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_x</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>x_start and x_end in pixels for this block</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>block_z</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>z_start and z_end in pixels for this block</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>y_shifts</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>y motion correction shifts for every frame in pixels</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>x_shifts</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>x motion correction shifts for every frame in pixels</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>z_shift=null</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>x motion correction shifts for every frame
in pixels</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>y_std</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of y shifts across all frames in pixels</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>x_std</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of x shifts across all frames in pixels</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>z_std=null</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>standard deviation of z shifts across all frames
in pixels</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FOV-tiled blocks used for non-rigid motion correction.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        NonRigidMotionCorrection (foreign key): Primary key from</span>
<span class="sd">            NonRigidMotionCorrection.</span>
<span class="sd">        block_id (int): Unique block ID.</span>
<span class="sd">        block_y (longblob): y_start and y_end in pixels for this block</span>
<span class="sd">        block_x (longblob): x_start and x_end in pixels for this block</span>
<span class="sd">        block_z (longblob): z_start and z_end in pixels for this block</span>
<span class="sd">        y_shifts (longblob): y motion correction shifts for every frame in pixels</span>
<span class="sd">        x_shifts (longblob): x motion correction shifts for every frame in pixels</span>
<span class="sd">        z_shift=null (longblob, optional): x motion correction shifts for every frame</span>
<span class="sd">            in pixels</span>
<span class="sd">        y_std (float): standard deviation of y shifts across all frames in pixels</span>
<span class="sd">        x_std (float): standard deviation of x shifts across all frames in pixels</span>
<span class="sd">        z_std=null (float, optional): standard deviation of z shifts across all frames</span>
<span class="sd">            in pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# FOV-tiled blocks used for non-rigid motion correction</span>
<span class="s2">    -&gt; master.NonRigidMotionCorrection</span>
<span class="s2">    block_id        : int</span>
<span class="s2">    ---</span>
<span class="s2">    block_y         : longblob  # (y_start, y_end) in pixel of this block</span>
<span class="s2">    block_x         : longblob  # (x_start, x_end) in pixel of this block</span>
<span class="s2">    block_z         : longblob  # (z_start, z_end) in pixel of this block</span>
<span class="s2">    y_shifts        : longblob  # (pixels) y motion correction shifts for every frame</span>
<span class="s2">    x_shifts        : longblob  # (pixels) x motion correction shifts for every frame</span>
<span class="s2">    z_shifts=null   : longblob  # (pixels) x motion correction shifts for every frame</span>
<span class="s2">    y_std           : float     # (pixels) standard deviation of y shifts across all frames</span>
<span class="s2">    x_std           : float     # (pixels) standard deviation of x shifts across all frames</span>
<span class="s2">    z_std=null      : float     # (pixels) standard deviation of z shifts across all frames</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.MotionCorrection.Summary" class="doc doc-heading">
        <code>Summary</code>


<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.Summary" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Summary images for each field and channel after corrections.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>MotionCorrection</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from MotionCorrection.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>scan.ScanInfo.Field</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from scan.ScanInfo.Field.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ref_image</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Image used as alignment template.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>average_image</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mean of registered frames.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>correlation_image</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Correlation map (computed during
cell detection).</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>max_proj_image</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Max of registered frames.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Summary</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summary images for each field and channel after corrections.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        MotionCorrection (foreign key): Primary key from MotionCorrection.</span>
<span class="sd">        scan.ScanInfo.Field (foreign key): Primary key from scan.ScanInfo.Field.</span>
<span class="sd">        ref_image (longblob): Image used as alignment template.</span>
<span class="sd">        average_image (longblob): Mean of registered frames.</span>
<span class="sd">        correlation_image (longblob, optional): Correlation map (computed during</span>
<span class="sd">            cell detection).</span>
<span class="sd">        max_proj_image (longblob, optional): Max of registered frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Summary images for each field and channel after corrections</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; scan.ScanInfo.Field</span>
<span class="s2">    ---</span>
<span class="s2">    ref_image               : longblob  # image used as alignment template</span>
<span class="s2">    average_image           : longblob  # mean of registered frames</span>
<span class="s2">    correlation_image=null  : longblob  # correlation map (computed during cell detection)</span>
<span class="s2">    max_proj_image=null     : longblob  # max of registered frames</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.MotionCorrection.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.MotionCorrection.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Populate MotionCorrection with results parsed from analysis outputs</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate MotionCorrection with results parsed from analysis outputs&quot;&quot;&quot;</span>

    <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

    <span class="n">field_keys</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;field_z&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;field_z&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;suite2p&quot;</span><span class="p">,</span> <span class="s2">&quot;extract&quot;</span><span class="p">]:</span>
        <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="n">motion_correct_channel</span> <span class="o">=</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alignment_channel</span>

        <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
        <span class="n">rigid_correction</span><span class="p">,</span> <span class="n">nonrigid_correction</span><span class="p">,</span> <span class="n">nonrigid_blocks</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">summary_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">s2p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># -- rigid motion correction --</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff&quot;</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff&quot;</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                    <span class="n">rigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">],</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1"># -- non-rigid motion correction --</span>
            <span class="k">if</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nonrigid&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nonrigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;block_height&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;block_size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;block_width&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;block_size&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;block_depth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;block_count_y&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nblocks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;block_count_x&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;nblocks&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;block_count_z&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">),</span>
                        <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nonrigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                        <span class="n">nonrigid_correction</span><span class="p">[</span><span class="s2">&quot;outlier_frames&quot;</span><span class="p">],</span>
                        <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;badframes&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">b_id</span><span class="p">,</span> <span class="p">(</span><span class="n">b_y</span><span class="p">,</span> <span class="n">b_x</span><span class="p">,</span> <span class="n">bshift_y</span><span class="p">,</span> <span class="n">bshift_x</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xblock&quot;</span><span class="p">],</span>
                        <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yblock&quot;</span><span class="p">],</span>
                        <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;yoff1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="n">s2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">&quot;xoff1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">b_id</span> <span class="ow">in</span> <span class="n">nonrigid_blocks</span><span class="p">:</span>
                        <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">],</span> <span class="n">bshift_y</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;y_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">],</span> <span class="n">bshift_x</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                            <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">][</span><span class="s2">&quot;x_shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nonrigid_blocks</span><span class="p">[</span><span class="n">b_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="n">b_id</span><span class="p">,</span>
                            <span class="s2">&quot;block_y&quot;</span><span class="p">:</span> <span class="n">b_y</span><span class="p">,</span>
                            <span class="s2">&quot;block_x&quot;</span><span class="p">:</span> <span class="n">b_x</span><span class="p">,</span>
                            <span class="s2">&quot;block_z&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">b_x</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                            <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">bshift_y</span><span class="p">,</span>
                            <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">bshift_x</span><span class="p">,</span>
                            <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="p">),</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">bshift_x</span><span class="p">),</span>
                                <span class="p">),</span>
                                <span class="mi">0</span><span class="p">,</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bshift_y</span><span class="p">),</span>
                            <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bshift_x</span><span class="p">),</span>
                            <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                        <span class="p">}</span>

            <span class="c1"># -- summary images --</span>
            <span class="n">motion_correction_key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">*</span> <span class="n">Processing</span> <span class="o">&amp;</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="n">field_keys</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;KEY&quot;</span><span class="p">)</span>
            <span class="n">summary_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">motion_correction_key</span><span class="p">,</span>
                    <span class="s2">&quot;ref_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">ref_image</span><span class="p">,</span>
                    <span class="s2">&quot;average_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">mean_image</span><span class="p">,</span>
                    <span class="s2">&quot;correlation_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">correlation_map</span><span class="p">,</span>
                    <span class="s2">&quot;max_proj_image&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">max_proj_image</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">({</span><span class="o">**</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;motion_correct_channel&quot;</span><span class="p">:</span> <span class="n">motion_correct_channel</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">rigid_correction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">rigid_correction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonrigid_correction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">NonRigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">nonrigid_correction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Block</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nonrigid_blocks</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">summary_images</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
        <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;motion_correct_channel&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">alignment_channel</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">is3D</span> <span class="o">=</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;is3D&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;pw_rigid&quot;</span><span class="p">]:</span>
            <span class="c1"># -- rigid motion correction --</span>
            <span class="n">rigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                        <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;shifts_rig&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">),</span>
                <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">RigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">rigid_correction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># -- non-rigid motion correction --</span>
            <span class="n">nonrigid_correction</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;block_height&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="s2">&quot;block_width&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="s2">&quot;block_depth&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">motion</span><span class="p">[</span><span class="s2">&quot;overlaps&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="mi">1</span>
                <span class="p">),</span>
                <span class="s2">&quot;block_count_x&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="p">),</span>
                <span class="s2">&quot;block_count_y&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="p">),</span>
                <span class="s2">&quot;block_count_z&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span>
                        <span class="nb">set</span><span class="p">(</span>
                            <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="mi">4</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is3D</span>
                    <span class="k">else</span> <span class="mi">1</span>
                <span class="p">),</span>
                <span class="s2">&quot;outlier_frames&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">nonrigid_blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="p">):</span>
                <span class="n">nonrigid_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;block_id&quot;</span><span class="p">:</span> <span class="n">b_id</span><span class="p">,</span>
                        <span class="s2">&quot;block_x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                <span class="n">b_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;block_y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;coord_shifts_els&quot;</span><span class="p">][</span>
                                <span class="n">b_id</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;block_z&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                    <span class="s2">&quot;coord_shifts_els&quot;</span>
                                <span class="p">][</span><span class="n">b_id</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">is3D</span>
                            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                    <span class="o">*</span><span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                                        <span class="s2">&quot;coord_shifts_els&quot;</span>
                                    <span class="p">][</span><span class="n">b_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                                <span class="p">),</span>
                                <span class="mi">0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;x_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                            <span class="s2">&quot;x_shifts_els&quot;</span>
                        <span class="p">][:,</span> <span class="n">b_id</span><span class="p">],</span>
                        <span class="s2">&quot;y_shifts&quot;</span><span class="p">:</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span>
                            <span class="s2">&quot;y_shifts_els&quot;</span>
                        <span class="p">][:,</span> <span class="n">b_id</span><span class="p">],</span>
                        <span class="s2">&quot;z_shifts&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;z_shifts_els&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="n">b_id</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="n">is3D</span>
                            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="n">b_id</span>
                                <span class="p">],</span>
                                <span class="mi">0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;x_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                            <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;x_shifts_els&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="n">b_id</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;y_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                            <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;y_shifts_els&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="n">b_id</span>
                            <span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;z_std&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span>
                                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;z_shifts_els&quot;</span><span class="p">][</span>
                                    <span class="p">:,</span> <span class="n">b_id</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">is3D</span>
                            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">NonRigidMotionCorrection</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">nonrigid_correction</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Block</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nonrigid_blocks</span><span class="p">)</span>

        <span class="c1"># -- summary images --</span>
        <span class="n">summary_images</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="o">**</span><span class="n">fkey</span><span class="p">,</span>
                <span class="s2">&quot;ref_image&quot;</span><span class="p">:</span> <span class="n">ref_image</span><span class="p">,</span>
                <span class="s2">&quot;average_image&quot;</span><span class="p">:</span> <span class="n">ave_img</span><span class="p">,</span>
                <span class="s2">&quot;correlation_image&quot;</span><span class="p">:</span> <span class="n">corr_img</span><span class="p">,</span>
                <span class="s2">&quot;max_proj_image&quot;</span><span class="p">:</span> <span class="n">max_img</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">fkey</span><span class="p">,</span> <span class="n">ref_image</span><span class="p">,</span> <span class="n">ave_img</span><span class="p">,</span> <span class="n">corr_img</span><span class="p">,</span> <span class="n">max_img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">field_keys</span><span class="p">,</span>
                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;reference_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is3D</span>
                <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;reference_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                <span class="p">],</span>
                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;average_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is3D</span>
                <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;average_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                <span class="p">],</span>
                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;correlation_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is3D</span>
                <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;correlation_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                <span class="p">],</span>
                <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;max_image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is3D</span>
                <span class="k">else</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">motion_correction</span><span class="p">[</span><span class="s2">&quot;max_image&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">summary_images</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.Segmentation" class="doc doc-heading">
        <code>Segmentation</code>


<a href="#element_calcium_imaging.imaging_no_curation.Segmentation" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Result of the Segmentation process.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Processing</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Processing.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Segmentation</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of the Segmentation process.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Processing (foreign key): Primary key from Processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Different mask segmentations.</span>
<span class="s2">    -&gt; Processing</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Mask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Details of the masks identified from the Segmentation procedure.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            Segmentation (foreign key): Primary key from Segmentation.</span>
<span class="sd">            mask (int): Unique mask ID.</span>
<span class="sd">            scan.Channel.proj(segmentation_channel=&#39;channel&#39;) (foreign key): Channel</span>
<span class="sd">                used for segmentation.</span>
<span class="sd">            mask_npix (int): Number of pixels in ROIs.</span>
<span class="sd">            mask_center_x (int): Center x coordinate in pixel.</span>
<span class="sd">            mask_center_y (int): Center y coordinate in pixel.</span>
<span class="sd">            mask_center_z (int): Center z coordinate in pixel.</span>
<span class="sd">            mask_xpix (longblob): X coordinates in pixels.</span>
<span class="sd">            mask_ypix (longblob): Y coordinates in pixels.</span>
<span class="sd">            mask_zpix (longblob): Z coordinates in pixels.</span>
<span class="sd">            mask_weights (longblob): Weights of the mask at the indices above.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; # A mask produced by segmentation.</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        mask               : smallint</span>
<span class="s2">        ---</span>
<span class="s2">        -&gt; scan.Channel.proj(segmentation_channel=&#39;channel&#39;)  # channel used for segmentation</span>
<span class="s2">        mask_npix          : int       # number of pixels in ROIs</span>
<span class="s2">        mask_center_x      : int       # center x coordinate in pixel</span>
<span class="s2">        mask_center_y      : int       # center y coordinate in pixel</span>
<span class="s2">        mask_center_z=null : int       # center z coordinate in pixel</span>
<span class="s2">        mask_xpix          : longblob  # x coordinates in pixels</span>
<span class="s2">        mask_ypix          : longblob  # y coordinates in pixels</span>
<span class="s2">        mask_zpix=null     : longblob  # z coordinates in pixels</span>
<span class="s2">        mask_weights       : longblob  # weights of the mask at the indices above</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate the Segmentation with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

        <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
            <span class="n">masks</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">plane</span><span class="p">,</span> <span class="n">s2p</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mask_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>  <span class="c1"># increment mask id from all &quot;plane&quot;</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">is_cell</span><span class="p">,</span> <span class="n">cell_prob</span><span class="p">,</span> <span class="n">mask_stat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">iscell</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">cell_prob</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">stat</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                            <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">segmentation_channel</span><span class="p">,</span>
                            <span class="s2">&quot;mask_npix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;npix&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;mask_center_x&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;mask_center_y&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;mask_center_z&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iplane&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                            <span class="s2">&quot;mask_xpix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;xpix&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;mask_ypix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;ypix&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;mask_zpix&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                                <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;npix&quot;</span><span class="p">],</span>
                                <span class="n">mask_stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iplane&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;mask_weights&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;lam&quot;</span><span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_cell</span><span class="p">:</span>
                        <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                                <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;suite2p_default_classifier&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                                <span class="s2">&quot;mask_type&quot;</span><span class="p">:</span> <span class="s2">&quot;soma&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">cell_prob</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
                <span class="n">MaskClassification</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;suite2p_default_classifier&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">MaskClassification</span><span class="o">.</span><span class="n">MaskType</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">cells</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
            <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
            <span class="p">)</span>

            <span class="n">masks</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">:</span> <span class="n">segmentation_channel</span><span class="p">,</span>
                        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_npix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_npix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_x&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_x&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_y&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_y&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_z&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_z&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_xpix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_xpix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_ypix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_ypix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_zpix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_zpix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_weights&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_weights&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">cnmf</span><span class="o">.</span><span class="n">estimates</span><span class="o">.</span><span class="n">idx_components</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">cnmf</span><span class="o">.</span><span class="n">estimates</span><span class="o">.</span><span class="n">idx_components</span><span class="p">:</span>
                        <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                                <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;caiman_default_classifier&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;mask_type&quot;</span><span class="p">:</span> <span class="s2">&quot;soma&quot;</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
                <span class="n">MaskClassification</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;caiman_default_classifier&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">MaskClassification</span><span class="o">.</span><span class="n">MaskType</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="n">cells</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="n">segmentation_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                    <span class="n">mask_npix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_npix&quot;</span><span class="p">],</span>
                    <span class="n">mask_center_x</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_x&quot;</span><span class="p">],</span>
                    <span class="n">mask_center_y</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_y&quot;</span><span class="p">],</span>
                    <span class="n">mask_center_z</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_z&quot;</span><span class="p">],</span>
                    <span class="n">mask_xpix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_xpix&quot;</span><span class="p">],</span>
                    <span class="n">mask_ypix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_ypix&quot;</span><span class="p">],</span>
                    <span class="n">mask_zpix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_zpix&quot;</span><span class="p">],</span>
                    <span class="n">mask_weights</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_weights&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">extract_dataset</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.Segmentation.Mask" class="doc doc-heading">
        <code>Mask</code>


<a href="#element_calcium_imaging.imaging_no_curation.Segmentation.Mask" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Details of the masks identified from the Segmentation procedure.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Segmentation</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Unique mask ID.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>scan.Channel.proj(segmentation_channel=&#39;channel&#39;)</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Channel
used for segmentation.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_npix</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of pixels in ROIs.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_center_x</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Center x coordinate in pixel.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_center_y</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Center y coordinate in pixel.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_center_z</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Center z coordinate in pixel.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_xpix</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>X coordinates in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_ypix</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Y coordinates in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_zpix</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Z coordinates in pixels.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_weights</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Weights of the mask at the indices above.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Mask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details of the masks identified from the Segmentation procedure.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Segmentation (foreign key): Primary key from Segmentation.</span>
<span class="sd">        mask (int): Unique mask ID.</span>
<span class="sd">        scan.Channel.proj(segmentation_channel=&#39;channel&#39;) (foreign key): Channel</span>
<span class="sd">            used for segmentation.</span>
<span class="sd">        mask_npix (int): Number of pixels in ROIs.</span>
<span class="sd">        mask_center_x (int): Center x coordinate in pixel.</span>
<span class="sd">        mask_center_y (int): Center y coordinate in pixel.</span>
<span class="sd">        mask_center_z (int): Center z coordinate in pixel.</span>
<span class="sd">        mask_xpix (longblob): X coordinates in pixels.</span>
<span class="sd">        mask_ypix (longblob): Y coordinates in pixels.</span>
<span class="sd">        mask_zpix (longblob): Z coordinates in pixels.</span>
<span class="sd">        mask_weights (longblob): Weights of the mask at the indices above.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; # A mask produced by segmentation.</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    mask               : smallint</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; scan.Channel.proj(segmentation_channel=&#39;channel&#39;)  # channel used for segmentation</span>
<span class="s2">    mask_npix          : int       # number of pixels in ROIs</span>
<span class="s2">    mask_center_x      : int       # center x coordinate in pixel</span>
<span class="s2">    mask_center_y      : int       # center y coordinate in pixel</span>
<span class="s2">    mask_center_z=null : int       # center z coordinate in pixel</span>
<span class="s2">    mask_xpix          : longblob  # x coordinates in pixels</span>
<span class="s2">    mask_ypix          : longblob  # y coordinates in pixels</span>
<span class="s2">    mask_zpix=null     : longblob  # z coordinates in pixels</span>
<span class="s2">    mask_weights       : longblob  # weights of the mask at the indices above</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.Segmentation.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.Segmentation.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Populate the Segmentation with the results parsed from analysis outputs.</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate the Segmentation with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

    <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
        <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
        <span class="n">masks</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">plane</span><span class="p">,</span> <span class="n">s2p</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>  <span class="c1"># increment mask id from all &quot;plane&quot;</span>
            <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">is_cell</span><span class="p">,</span> <span class="n">cell_prob</span><span class="p">,</span> <span class="n">mask_stat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">iscell</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">cell_prob</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">stat</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                        <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">:</span> <span class="n">s2p</span><span class="o">.</span><span class="n">segmentation_channel</span><span class="p">,</span>
                        <span class="s2">&quot;mask_npix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;npix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_x&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_y&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;mask_center_z&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iplane&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                        <span class="s2">&quot;mask_xpix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;xpix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_ypix&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;ypix&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;mask_zpix&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;npix&quot;</span><span class="p">],</span>
                            <span class="n">mask_stat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iplane&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">),</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;mask_weights&quot;</span><span class="p">:</span> <span class="n">mask_stat</span><span class="p">[</span><span class="s2">&quot;lam&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is_cell</span><span class="p">:</span>
                    <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;suite2p_default_classifier&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                            <span class="s2">&quot;mask_type&quot;</span><span class="p">:</span> <span class="s2">&quot;soma&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">cell_prob</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">MaskClassification</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;suite2p_default_classifier&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">MaskClassification</span><span class="o">.</span><span class="n">MaskType</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">cells</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
        <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
        <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
        <span class="p">)</span>

        <span class="n">masks</span><span class="p">,</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">:</span> <span class="n">segmentation_channel</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_npix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_npix&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_center_x&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_x&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_center_y&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_y&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_center_z&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_z&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_xpix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_xpix&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_ypix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_ypix&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_zpix&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_zpix&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;mask_weights&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_weights&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">cnmf</span><span class="o">.</span><span class="n">estimates</span><span class="o">.</span><span class="n">idx_components</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">cnmf</span><span class="o">.</span><span class="n">estimates</span><span class="o">.</span><span class="n">idx_components</span><span class="p">:</span>
                    <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;caiman_default_classifier&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;mask_type&quot;</span><span class="p">:</span> <span class="s2">&quot;soma&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">MaskClassification</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;mask_classification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;caiman_default_classifier&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">MaskClassification</span><span class="o">.</span><span class="n">MaskType</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">cells</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_direct_insert</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
        <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="n">segmentation_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                <span class="n">mask_npix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_npix&quot;</span><span class="p">],</span>
                <span class="n">mask_center_x</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_x&quot;</span><span class="p">],</span>
                <span class="n">mask_center_y</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_y&quot;</span><span class="p">],</span>
                <span class="n">mask_center_z</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_center_z&quot;</span><span class="p">],</span>
                <span class="n">mask_xpix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_xpix&quot;</span><span class="p">],</span>
                <span class="n">mask_ypix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_ypix&quot;</span><span class="p">],</span>
                <span class="n">mask_zpix</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_zpix&quot;</span><span class="p">],</span>
                <span class="n">mask_weights</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_weights&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">extract_dataset</span><span class="o">.</span><span class="n">load_results</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">ignore_extra_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.MaskClassificationMethod" class="doc doc-heading">
        <code>MaskClassificationMethod</code>


<a href="#element_calcium_imaging.imaging_no_curation.MaskClassificationMethod" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Available mask classification methods.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>mask_classification_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mask classification method.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">MaskClassificationMethod</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Available mask classification methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        mask_classification_method (str): Mask classification method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    mask_classification_method: varchar(48)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;suite2p_default_classifier&quot;</span><span class="p">,</span> <span class="s2">&quot;caiman_default_classifier&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.MaskClassification" class="doc doc-heading">
        <code>MaskClassification</code>


<a href="#element_calcium_imaging.imaging_no_curation.MaskClassification" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Classes assigned to each mask.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Segmentation</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>MaskClassificationMethod</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from
MaskClassificationMethod.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">MaskClassification</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Classes assigned to each mask.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Segmentation (foreign key): Primary key from Segmentation.</span>
<span class="sd">        MaskClassificationMethod (foreign key): Primary key from</span>
<span class="sd">            MaskClassificationMethod.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; Segmentation</span>
<span class="s2">    -&gt; MaskClassificationMethod</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">MaskType</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Type assigned to each mask.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            MaskClassification (foreign key): Primary key from MaskClassification.</span>
<span class="sd">            Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">            MaskType: Primary key from MaskType.</span>
<span class="sd">            confidence (float, optional): Confidence level of the mask classification.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; Segmentation.Mask</span>
<span class="s2">        ---</span>
<span class="s2">        -&gt; MaskType</span>
<span class="s2">        confidence=null: float</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.MaskClassification.MaskType" class="doc doc-heading">
        <code>MaskType</code>


<a href="#element_calcium_imaging.imaging_no_curation.MaskClassification.MaskType" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Type assigned to each mask.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>MaskClassification</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from MaskClassification.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>Segmentation.Mask</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.Mask.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>MaskType</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from MaskType.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>confidence</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Confidence level of the mask classification.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MaskType</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Type assigned to each mask.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        MaskClassification (foreign key): Primary key from MaskClassification.</span>
<span class="sd">        Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">        MaskType: Primary key from MaskType.</span>
<span class="sd">        confidence (float, optional): Confidence level of the mask classification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; Segmentation.Mask</span>
<span class="s2">    ---</span>
<span class="s2">    -&gt; MaskType</span>
<span class="s2">    confidence=null: float</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.Fluorescence" class="doc doc-heading">
        <code>Fluorescence</code>


<a href="#element_calcium_imaging.imaging_no_curation.Fluorescence" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Fluorescence traces.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Segmentation</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Fluorescence</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fluorescence traces.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Segmentation (foreign key): Primary key from Segmentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Fluorescence traces before spike extraction or filtering</span>
<span class="s2">    -&gt; Segmentation</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Traces obtained from segmented region of interests.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">            Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">            scan.Channel.proj(fluo_channel=&#39;channel&#39;) (int): The channel that this trace</span>
<span class="sd">                comes from.</span>
<span class="sd">            fluorescence (longblob): Fluorescence trace associated with this mask.</span>
<span class="sd">            neuropil_fluorescence (longblob, optional): Neuropil fluorescence trace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; Segmentation.Mask</span>
<span class="s2">        -&gt; scan.Channel.proj(fluo_channel=&#39;channel&#39;)  # The channel that this trace comes from</span>
<span class="s2">        ---</span>
<span class="s2">        fluorescence                : longblob  # Fluorescence trace associated with this mask</span>
<span class="s2">        neuropil_fluorescence=null  : longblob  # Neuropil fluorescence trace</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate the Fluorescence with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

        <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
            <span class="n">fluo_traces</span><span class="p">,</span> <span class="n">fluo_chn2_traces</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s2p</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">mask_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>  <span class="c1"># increment mask id from all &quot;plane&quot;</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fneu</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">Fneu</span><span class="p">)):</span>
                    <span class="n">fluo_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                            <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
                            <span class="s2">&quot;neuropil_fluorescence&quot;</span><span class="p">:</span> <span class="n">fneu</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F_chan2</span><span class="p">):</span>
                    <span class="n">mask_chn2_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="n">fluo_chn2_traces</span>
                    <span class="p">)</span>  <span class="c1"># increment mask id from all planes</span>
                    <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">fneu2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F_chan2</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">Fneu_chan2</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">fluo_chn2_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_chn2_count</span><span class="p">,</span>
                                <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">f2</span><span class="p">,</span>
                                <span class="s2">&quot;neuropil_fluorescence&quot;</span><span class="p">:</span> <span class="n">fneu2</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span> <span class="o">+</span> <span class="n">fluo_chn2_traces</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
            <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
            <span class="p">)</span>

            <span class="n">fluo_traces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">fluo_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="n">segmentation_channel</span><span class="p">,</span>
                        <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;inferred_trace&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
            <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="n">fluo_traces</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_id</span><span class="p">,</span>
                    <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">fluorescence</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">fluorescence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extract_dataset</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.Fluorescence.Trace" class="doc doc-heading">
        <code>Trace</code>


<a href="#element_calcium_imaging.imaging_no_curation.Fluorescence.Trace" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Traces obtained from segmented region of interests.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Fluorescence</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>Segmentation.Mask</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.Mask.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>scan.Channel.proj(fluo_channel=&#39;channel&#39;)</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The channel that this trace
comes from.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>fluorescence</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Fluorescence trace associated with this mask.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>neuropil_fluorescence</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Neuropil fluorescence trace.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Traces obtained from segmented region of interests.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">        Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">        scan.Channel.proj(fluo_channel=&#39;channel&#39;) (int): The channel that this trace</span>
<span class="sd">            comes from.</span>
<span class="sd">        fluorescence (longblob): Fluorescence trace associated with this mask.</span>
<span class="sd">        neuropil_fluorescence (longblob, optional): Neuropil fluorescence trace.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; Segmentation.Mask</span>
<span class="s2">    -&gt; scan.Channel.proj(fluo_channel=&#39;channel&#39;)  # The channel that this trace comes from</span>
<span class="s2">    ---</span>
<span class="s2">    fluorescence                : longblob  # Fluorescence trace associated with this mask</span>
<span class="s2">    neuropil_fluorescence=null  : longblob  # Neuropil fluorescence trace</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.Fluorescence.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.Fluorescence.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Populate the Fluorescence with the results parsed from analysis outputs.</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate the Fluorescence with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

    <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
        <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
        <span class="n">fluo_traces</span><span class="p">,</span> <span class="n">fluo_chn2_traces</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s2p</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">mask_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>  <span class="c1"># increment mask id from all &quot;plane&quot;</span>
            <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fneu</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">Fneu</span><span class="p">)):</span>
                <span class="n">fluo_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                        <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_count</span><span class="p">,</span>
                        <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span>
                        <span class="s2">&quot;neuropil_fluorescence&quot;</span><span class="p">:</span> <span class="n">fneu</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F_chan2</span><span class="p">):</span>
                <span class="n">mask_chn2_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">fluo_chn2_traces</span>
                <span class="p">)</span>  <span class="c1"># increment mask id from all planes</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">fneu2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">s2p</span><span class="o">.</span><span class="n">F_chan2</span><span class="p">,</span> <span class="n">s2p</span><span class="o">.</span><span class="n">Fneu_chan2</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">fluo_chn2_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                            <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_idx</span> <span class="o">+</span> <span class="n">mask_chn2_count</span><span class="p">,</span>
                            <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">f2</span><span class="p">,</span>
                            <span class="s2">&quot;neuropil_fluorescence&quot;</span><span class="p">:</span> <span class="n">fneu2</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span> <span class="o">+</span> <span class="n">fluo_chn2_traces</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
        <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
        <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
        <span class="p">)</span>

        <span class="n">fluo_traces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">fluo_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="n">segmentation_channel</span><span class="p">,</span>
                    <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;inferred_trace&quot;</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
        <span class="n">extract_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="n">fluo_traces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="o">**</span><span class="n">key</span><span class="p">,</span>
                <span class="s2">&quot;mask&quot;</span><span class="p">:</span> <span class="n">mask_id</span><span class="p">,</span>
                <span class="s2">&quot;fluo_channel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;fluorescence&quot;</span><span class="p">:</span> <span class="n">fluorescence</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">fluorescence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">extract_dataset</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">fluo_traces</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.ActivityExtractionMethod" class="doc doc-heading">
        <code>ActivityExtractionMethod</code>


<a href="#element_calcium_imaging.imaging_no_curation.ActivityExtractionMethod" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Lookup">Lookup</span></code></p>

  
      <p>Available activity extraction methods.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>extraction_method</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Extraction method.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">ActivityExtractionMethod</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Lookup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Available activity extraction methods.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        extraction_method (str): Extraction method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Activity extraction method</span>
<span class="s2">    extraction_method: varchar(32)</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;suite2p_deconvolution&quot;</span><span class="p">,</span> <span class="s2">&quot;caiman_deconvolution&quot;</span><span class="p">,</span> <span class="s2">&quot;caiman_dff&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.Activity" class="doc doc-heading">
        <code>Activity</code>


<a href="#element_calcium_imaging.imaging_no_curation.Activity" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Inferred neural activity from fluorescence trace (e.g. dff, spikes, etc.).</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Fluorescence</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ActivityExtractionMethod</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from
ActivityExtractionMethod.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">Activity</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inferred neural activity from fluorescence trace (e.g. dff, spikes, etc.).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">        ActivityExtractionMethod (foreign key): Primary key from</span>
<span class="sd">            ActivityExtractionMethod.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Neural Activity</span>
<span class="s2">    -&gt; Fluorescence</span>
<span class="s2">    -&gt; ActivityExtractionMethod</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trace(s) for each mask.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            Activity (foreign key): Primary key from Activity.</span>
<span class="sd">            Fluorescence.Trace (foreign key): Fluorescence.Trace.</span>
<span class="sd">            activity_trace (longblob): Neural activity from fluorescence trace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; Fluorescence.Trace</span>
<span class="s2">        ---</span>
<span class="s2">        activity_trace: longblob</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">suite2p_key_source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Fluorescence</span>
            <span class="o">*</span> <span class="n">ActivityExtractionMethod</span>
            <span class="o">*</span> <span class="n">ProcessingParamSet</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="s2">&quot;processing_method&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="s1">&#39;processing_method = &quot;suite2p&quot;&#39;</span>
            <span class="o">&amp;</span> <span class="s1">&#39;extraction_method LIKE &quot;suite2p%&quot;&#39;</span>
        <span class="p">)</span>
        <span class="n">caiman_key_source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Fluorescence</span>
            <span class="o">*</span> <span class="n">ActivityExtractionMethod</span>
            <span class="o">*</span> <span class="n">ProcessingParamSet</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="s2">&quot;processing_method&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="s1">&#39;processing_method = &quot;caiman&quot;&#39;</span>
            <span class="o">&amp;</span> <span class="s1">&#39;extraction_method LIKE &quot;caiman%&quot;&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">suite2p_key_source</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span> <span class="o">+</span> <span class="n">caiman_key_source</span><span class="o">.</span><span class="n">proj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate the Activity with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

        <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;suite2p_deconvolution&quot;</span><span class="p">:</span>
                <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
                <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
                <span class="n">spikes</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask_idx</span><span class="p">,</span>
                        <span class="n">fluo_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">activity_trace</span><span class="o">=</span><span class="n">spks</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">spks</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                        <span class="n">s</span>
                        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">plane</span><span class="o">.</span><span class="n">spks</span>
                    <span class="p">)</span>
                <span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
            <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

            <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;caiman_deconvolution&quot;</span><span class="p">,</span>
                <span class="s2">&quot;caiman_dff&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">attr_mapper</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;caiman_deconvolution&quot;</span><span class="p">:</span> <span class="s2">&quot;spikes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;caiman_dff&quot;</span><span class="p">:</span> <span class="s2">&quot;dff&quot;</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
                <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                    <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                        <span class="n">fluo_channel</span><span class="o">=</span><span class="n">segmentation_channel</span><span class="p">,</span>
                        <span class="n">activity_trace</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="n">attr_mapper</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]]],</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.Activity.Trace" class="doc doc-heading">
        <code>Trace</code>


<a href="#element_calcium_imaging.imaging_no_curation.Activity.Trace" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Trace(s) for each mask.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Activity</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Activity.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>Fluorescence.Trace</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Fluorescence.Trace.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>activity_trace</code></td>
          <td>
                <code>longblob</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Neural activity from fluorescence trace.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace(s) for each mask.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Activity (foreign key): Primary key from Activity.</span>
<span class="sd">        Fluorescence.Trace (foreign key): Fluorescence.Trace.</span>
<span class="sd">        activity_trace (longblob): Neural activity from fluorescence trace.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; Fluorescence.Trace</span>
<span class="s2">    ---</span>
<span class="s2">    activity_trace: longblob</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.Activity.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.Activity.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Populate the Activity with the results parsed from analysis outputs.</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate the Activity with the results parsed from analysis outputs.&quot;&quot;&quot;</span>

    <span class="n">method</span><span class="p">,</span> <span class="n">imaging_dataset</span> <span class="o">=</span> <span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ProcessingTask</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;suite2p_deconvolution&quot;</span><span class="p">:</span>
            <span class="n">suite2p_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>
            <span class="c1"># ---- iterate through all s2p plane outputs ----</span>
            <span class="n">spikes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask_idx</span><span class="p">,</span>
                    <span class="n">fluo_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">activity_trace</span><span class="o">=</span><span class="n">spks</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">mask_idx</span><span class="p">,</span> <span class="n">spks</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">s</span>
                    <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">suite2p_dataset</span><span class="o">.</span><span class="n">planes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">plane</span><span class="o">.</span><span class="n">spks</span>
                <span class="p">)</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
        <span class="n">caiman_dataset</span> <span class="o">=</span> <span class="n">imaging_dataset</span>

        <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;caiman_deconvolution&quot;</span><span class="p">,</span>
            <span class="s2">&quot;caiman_dff&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">attr_mapper</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;caiman_deconvolution&quot;</span><span class="p">:</span> <span class="s2">&quot;spikes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;caiman_dff&quot;</span><span class="p">:</span> <span class="s2">&quot;dff&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># infer &quot;segmentation_channel&quot; - from params if available, else from caiman loader</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">ProcessingTask</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">)</span>
            <span class="n">segmentation_channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;segmentation_channel&quot;</span><span class="p">,</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">segmentation_channel</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="s2">&quot;mask_id&quot;</span><span class="p">],</span>
                    <span class="n">fluo_channel</span><span class="o">=</span><span class="n">segmentation_channel</span><span class="p">,</span>
                    <span class="n">activity_trace</span><span class="o">=</span><span class="n">mask</span><span class="p">[</span><span class="n">attr_mapper</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="s2">&quot;extraction_method&quot;</span><span class="p">]]],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">caiman_dataset</span><span class="o">.</span><span class="n">masks</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h2 id="element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics" class="doc doc-heading">
        <code>ProcessingQualityMetrics</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Computed">Computed</span></code></p>

  
      <p>Quality metrics used to evaluate the results of the calcium imaging analysis pipeline.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Fluorescence</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@schema</span>
<span class="k">class</span> <span class="nc">ProcessingQualityMetrics</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Computed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quality metrics used to evaluate the results of the calcium imaging analysis pipeline.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; Fluorescence</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Mask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Quality metrics used to evaluate the masks.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">            Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">            mask_area (float): Mask area in square micrometer.</span>
<span class="sd">            roundness (float): Roundness between 0 and 1. Values closer to 1 are rounder.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; Segmentation.Mask</span>
<span class="s2">        ---</span>
<span class="s2">        mask_area=null: float  # Mask area in square micrometer.</span>
<span class="s2">        roundness: float       # Roundness between 0 and 1. Values closer to 1 are rounder.</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Quality metrics used to evaluate the fluorescence traces.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">            Fluorescence.Trace (foreign key): Primary key from Fluorescence.Trace.</span>
<span class="sd">            skewness (float): Skewness of the fluorescence trace.</span>
<span class="sd">            variance (float): Variance of the fluorescence trace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        -&gt; master</span>
<span class="s2">        -&gt; Fluorescence.Trace</span>
<span class="s2">        ---</span>
<span class="s2">        skewness: float   # Skewness of the fluorescence trace.</span>
<span class="s2">        variance: float   # Variance of the fluorescence trace.</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Populate the ProcessingQualityMetrics table and its part tables.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span>

        <span class="p">(</span>
            <span class="n">mask_xpixs</span><span class="p">,</span>
            <span class="n">mask_ypixs</span><span class="p">,</span>
            <span class="n">mask_weights</span><span class="p">,</span>
            <span class="n">fluorescence</span><span class="p">,</span>
            <span class="n">fluo_channels</span><span class="p">,</span>
            <span class="n">mask_ids</span><span class="p">,</span>
            <span class="n">mask_npix</span><span class="p">,</span>
            <span class="n">px_height</span><span class="p">,</span>
            <span class="n">px_width</span><span class="p">,</span>
            <span class="n">um_height</span><span class="p">,</span>
            <span class="n">um_width</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Segmentation</span><span class="o">.</span><span class="n">Mask</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">*</span> <span class="n">Fluorescence</span><span class="o">.</span><span class="n">Trace</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
            <span class="s2">&quot;mask_xpix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mask_ypix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mask_weights&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fluorescence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fluo_channel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mask_npix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;px_height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;px_width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;um_height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;um_width&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">norm_mean</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">roundnesses</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">norm_mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">aweights</span><span class="o">=</span><span class="n">w</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mask_xpixs</span><span class="p">,</span> <span class="n">mask_ypixs</span><span class="p">,</span> <span class="n">mask_weights</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">fluorescence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_id</span><span class="p">,</span> <span class="n">mask_area</span><span class="o">=</span><span class="n">mask_area</span><span class="p">,</span> <span class="n">roundness</span><span class="o">=</span><span class="n">roundness</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">mask_area</span><span class="p">,</span> <span class="n">roundness</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">mask_ids</span><span class="p">,</span>
                <span class="n">mask_npix</span> <span class="o">*</span> <span class="p">(</span><span class="n">um_height</span> <span class="o">/</span> <span class="n">px_height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">um_width</span> <span class="o">/</span> <span class="n">px_width</span><span class="p">),</span>
                <span class="n">roundnesses</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="n">fluo_channel</span><span class="o">=</span><span class="n">fluo_channel</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask_id</span><span class="p">,</span>
                <span class="n">skewness</span><span class="o">=</span><span class="n">skewness</span><span class="p">,</span>
                <span class="n">variance</span><span class="o">=</span><span class="n">variance</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">fluo_channel</span><span class="p">,</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">variance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">fluo_channels</span><span class="p">,</span>
                <span class="n">mask_ids</span><span class="p">,</span>
                <span class="n">skew</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">fluorescence</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Mask" class="doc doc-heading">
        <code>Mask</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Mask" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Quality metrics used to evaluate the masks.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Fluorescence</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>Segmentation.Mask</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Segmentation.Mask.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mask_area</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Mask area in square micrometer.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>roundness</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Roundness between 0 and 1. Values closer to 1 are rounder.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Mask</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quality metrics used to evaluate the masks.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">        Segmentation.Mask (foreign key): Primary key from Segmentation.Mask.</span>
<span class="sd">        mask_area (float): Mask area in square micrometer.</span>
<span class="sd">        roundness (float): Roundness between 0 and 1. Values closer to 1 are rounder.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; Segmentation.Mask</span>
<span class="s2">    ---</span>
<span class="s2">    mask_area=null: float  # Mask area in square micrometer.</span>
<span class="s2">    roundness: float       # Roundness between 0 and 1. Values closer to 1 are rounder.</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-class">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Trace" class="doc doc-heading">
        <code>Trace</code>


<a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.Trace" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="datajoint">dj</span>.<span title="datajoint.Part">Part</span></code></p>

  
      <p>Quality metrics used to evaluate the fluorescence traces.</p>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>Fluorescence</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>Fluorescence.Trace</code></td>
          <td>
                <code>foreign key</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Primary key from Fluorescence.Trace.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>skewness</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Skewness of the fluorescence trace.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>variance</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Variance of the fluorescence trace.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">dj</span><span class="o">.</span><span class="n">Part</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Quality metrics used to evaluate the fluorescence traces.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Fluorescence (foreign key): Primary key from Fluorescence.</span>
<span class="sd">        Fluorescence.Trace (foreign key): Primary key from Fluorescence.Trace.</span>
<span class="sd">        skewness (float): Skewness of the fluorescence trace.</span>
<span class="sd">        variance (float): Variance of the fluorescence trace.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">definition</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    -&gt; master</span>
<span class="s2">    -&gt; Fluorescence.Trace</span>
<span class="s2">    ---</span>
<span class="s2">    skewness: float   # Skewness of the fluorescence trace.</span>
<span class="s2">    variance: float   # Variance of the fluorescence trace.</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">





  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h3 id="element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.make" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.ProcessingQualityMetrics.make" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Populate the ProcessingQualityMetrics table and its part tables.</p>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populate the ProcessingQualityMetrics table and its part tables.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span>

    <span class="p">(</span>
        <span class="n">mask_xpixs</span><span class="p">,</span>
        <span class="n">mask_ypixs</span><span class="p">,</span>
        <span class="n">mask_weights</span><span class="p">,</span>
        <span class="n">fluorescence</span><span class="p">,</span>
        <span class="n">fluo_channels</span><span class="p">,</span>
        <span class="n">mask_ids</span><span class="p">,</span>
        <span class="n">mask_npix</span><span class="p">,</span>
        <span class="n">px_height</span><span class="p">,</span>
        <span class="n">px_width</span><span class="p">,</span>
        <span class="n">um_height</span><span class="p">,</span>
        <span class="n">um_width</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Segmentation</span><span class="o">.</span><span class="n">Mask</span> <span class="o">*</span> <span class="n">scan</span><span class="o">.</span><span class="n">ScanInfo</span><span class="o">.</span><span class="n">Field</span> <span class="o">*</span> <span class="n">Fluorescence</span><span class="o">.</span><span class="n">Trace</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span>
        <span class="s2">&quot;mask_xpix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mask_ypix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mask_weights&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fluorescence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fluo_channel&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mask_npix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;px_height&quot;</span><span class="p">,</span>
        <span class="s2">&quot;px_width&quot;</span><span class="p">,</span>
        <span class="s2">&quot;um_height&quot;</span><span class="p">,</span>
        <span class="s2">&quot;um_width&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">norm_mean</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">roundnesses</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">norm_mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">aweights</span><span class="o">=</span><span class="n">w</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mask_xpixs</span><span class="p">,</span> <span class="n">mask_ypixs</span><span class="p">,</span> <span class="n">mask_weights</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">fluorescence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">insert1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Mask</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask_id</span><span class="p">,</span> <span class="n">mask_area</span><span class="o">=</span><span class="n">mask_area</span><span class="p">,</span> <span class="n">roundness</span><span class="o">=</span><span class="n">roundness</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">mask_area</span><span class="p">,</span> <span class="n">roundness</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">mask_ids</span><span class="p">,</span>
            <span class="n">mask_npix</span> <span class="o">*</span> <span class="p">(</span><span class="n">um_height</span> <span class="o">/</span> <span class="n">px_height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">um_width</span> <span class="o">/</span> <span class="n">px_width</span><span class="p">),</span>
            <span class="n">roundnesses</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">Trace</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">fluo_channel</span><span class="o">=</span><span class="n">fluo_channel</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask_id</span><span class="p">,</span>
            <span class="n">skewness</span><span class="o">=</span><span class="n">skewness</span><span class="p">,</span>
            <span class="n">variance</span><span class="o">=</span><span class="n">variance</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">fluo_channel</span><span class="p">,</span> <span class="n">mask_id</span><span class="p">,</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">variance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">fluo_channels</span><span class="p">,</span>
            <span class="n">mask_ids</span><span class="p">,</span>
            <span class="n">skew</span><span class="p">(</span><span class="n">fluorescence</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">fluorescence</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>






<div class="doc doc-object doc-function">



<h2 id="element_calcium_imaging.imaging_no_curation.get_loader_result" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span></code>

<a href="#element_calcium_imaging.imaging_no_curation.get_loader_result" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the processed imaging results from a suite2p or caiman loader.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>key</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The <code>key</code> to one entry of ProcessingTask or Curation</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>table</code></td>
          <td>
                <code><span title="datajoint">dj</span>.<span title="datajoint.Table">Table</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A datajoint table to retrieve the loaded results from (e.g.
ProcessingTask, Curation)</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>NotImplementedError</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If the processing_method is different than 'suite2p' or
'caiman'.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="collections.abc.Callable">Callable</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A loader object of the loaded results (e.g. suite2p.Suite2p or caiman.CaImAn,</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="collections.abc.Callable">Callable</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>see element-interface for more information on the loaders.)</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>element_calcium_imaging/imaging_no_curation.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_loader_result</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">dj</span><span class="o">.</span><span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the processed imaging results from a suite2p or caiman loader.</span>

<span class="sd">    Args:</span>
<span class="sd">        key (dict): The `key` to one entry of ProcessingTask or Curation</span>
<span class="sd">        table (dj.Table): A datajoint table to retrieve the loaded results from (e.g.</span>
<span class="sd">            ProcessingTask, Curation)</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: If the processing_method is different than &#39;suite2p&#39; or</span>
<span class="sd">            &#39;caiman&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A loader object of the loaded results (e.g. suite2p.Suite2p or caiman.CaImAn,</span>
<span class="sd">        see element-interface for more information on the loaders.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span><span class="p">,</span> <span class="n">output_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">ProcessingParamSet</span> <span class="o">*</span> <span class="n">table</span> <span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch1</span><span class="p">(</span>
        <span class="s2">&quot;processing_method&quot;</span><span class="p">,</span> <span class="n">_table_attribute_mapper</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">output_path</span> <span class="o">=</span> <span class="n">find_full_path</span><span class="p">(</span><span class="n">get_imaging_root_data_dir</span><span class="p">(),</span> <span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;suite2p&quot;</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;MotionCorrection&quot;</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">suite2p_loader</span>

        <span class="n">loaded_dataset</span> <span class="o">=</span> <span class="n">suite2p_loader</span><span class="o">.</span><span class="n">Suite2p</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;caiman&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">caiman_loader</span>

        <span class="n">loaded_dataset</span> <span class="o">=</span> <span class="n">caiman_loader</span><span class="o">.</span><span class="n">CaImAn</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;extract&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">element_interface</span> <span class="kn">import</span> <span class="n">extract_loader</span>

        <span class="n">loaded_dataset</span> <span class="o">=</span> <span class="n">extract_loader</span><span class="o">.</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown/unimplemented method: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">method</span><span class="p">,</span> <span class="n">loaded_dataset</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://www.datajoint.com" target="_blank" rel="noopener" title="DataJoint" class="md-social__link">
      <?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 15.1.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="260.479px" height="365.463px" viewBox="0 0 260.479 365.463" enable-background="new 0 0 260.479 365.463"
	 xml:space="preserve">
<g>
	<path d="M4.638,361.434c0,0,124.071-124.072,135.896-357.434c0,0,29.555,189.053,115.266,256.988
		C255.799,260.988,173.038,249.174,4.638,361.434z"/>
</g>
</svg>
    </a>
  
    
    
    
    
    <a href="https://datajoint.slack.com" target="_blank" rel="noopener" title="Slack" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M94.12 315.1c0 25.9-21.16 47.06-47.06 47.06S0 341 0 315.1c0-25.9 21.16-47.06 47.06-47.06h47.06v47.06zm23.72 0c0-25.9 21.16-47.06 47.06-47.06s47.06 21.16 47.06 47.06v117.84c0 25.9-21.16 47.06-47.06 47.06s-47.06-21.16-47.06-47.06V315.1zm47.06-188.98c-25.9 0-47.06-21.16-47.06-47.06S139 32 164.9 32s47.06 21.16 47.06 47.06v47.06H164.9zm0 23.72c25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06H47.06C21.16 243.96 0 222.8 0 196.9s21.16-47.06 47.06-47.06H164.9zm188.98 47.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06s-21.16 47.06-47.06 47.06h-47.06V196.9zm-23.72 0c0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06V79.06c0-25.9 21.16-47.06 47.06-47.06 25.9 0 47.06 21.16 47.06 47.06V196.9zM283.1 385.88c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06-25.9 0-47.06-21.16-47.06-47.06v-47.06h47.06zm0-23.72c-25.9 0-47.06-21.16-47.06-47.06 0-25.9 21.16-47.06 47.06-47.06h117.84c25.9 0 47.06 21.16 47.06 47.06 0 25.9-21.16 47.06-47.06 47.06H283.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/company/datajoint" target="_blank" rel="noopener" title="LinkedIn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://twitter.com/datajoint" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://github.com/datajoint" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://hub.docker.com/u/datajoint" target="_blank" rel="noopener" title="DockerHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://pypi.org/user/datajointbot" target="_blank" rel="noopener" title="PyPI" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6zM286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3zM167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4zm-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://stackoverflow.com/questions/tagged/datajoint" target="_blank" rel="noopener" title="StackOverflow" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M290.7 311 95 269.7 86.8 309l195.7 41zm51-87L188.2 95.7l-25.5 30.8 153.5 128.3zm-31.2 39.7L129.2 179l-16.7 36.5L293.7 300zM262 32l-32 24 119.3 160.3 32-24zm20.5 328h-200v39.7h200zm39.7 80H42.7V320h-40v160h359.5V320h-40z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.youtube.com/channel/UCdeCuFOTCXlVMRzh6Wk-lGg" target="_blank" rel="noopener" title="YouTube" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["toc.integrate", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
        <script src="https://js-na1.hs-scripts.com/23133402.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>